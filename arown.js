const socket=io();let state={currentUser:null,currentRoomId:null,isJoined:!1,autoScrollEnabled:!0,isLoadingMoreMessages:!1,lastMessageId:null,roomUsers:[],userColors:{},displayedUsernames:new Set,typingTimeout:null};const USER_COLORS=["#28a745","#dc3545","#ffc107","#6f42c1","#fd7e14","#20c997","#e83e8c","#6c757d","#17a2b8"],CONFIG={maxMessageLength:2e3,maxFileSize:5242880,typingDebounce:1e3,seenDebounce:500,usernameDisplayTimeout:1e4},SECRET_KEY="xSAjwEE70Ilu4EN6iM1yTB-9A6ut4OfWDVmlZi82Q_w=";function encryptMessage(e){try{let t=CryptoJS.lib.WordArray.random(16),s=CryptoJS.AES.encrypt(e,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:t});return t.toString()+":"+s.toString()}catch(n){return console.error("Encryption error:",n),null}}function decryptMessage(e){try{let t=e.split(":");if(2!==t.length)return console.error("Invalid ciphertext format"),null;let s=CryptoJS.enc.Hex.parse(t[0]),n=t[1],o=CryptoJS.AES.decrypt(n,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:s}).toString(CryptoJS.enc.Utf8);return o||null}catch(r){return console.error("Decryption error:",r),null}}function validateUsername(e){return/^[a-zA-Z0-9_-]{2,50}$/.test(e)}function validateRoomId(e){return/^[a-zA-Z0-9_-]{1,100}$/.test(e)}function validateInputs(){let e=document.getElementById("username").value.trim(),t=document.getElementById("roomId").value.trim(),s=validateUsername(e),n=validateRoomId(t);return document.getElementById("username").style.backgroundColor=s?"lightgreen":"lightcoral",document.getElementById("roomId").style.backgroundColor=n?"lightgreen":"lightcoral",s&&n}function sanitizeInput(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function scrollToBottom(){let e=document.getElementById("messages");e.scrollTop=e.scrollHeight}function assignUserColor(e){if(!state.userColors[e]){let t=Object.keys(state.userColors).length%USER_COLORS.length;state.userColors[e]=USER_COLORS[t]}return state.userColors[e]}function showNotification(e,t="info"){let s=document.createElement("div");s.className=`notification ${t}`,s.textContent=e,s.style.cssText=`
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background: ${"error"===t?"#dc3545":"#28a745"};
    color: white;
    border-radius: 5px;
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `,document.body.appendChild(s),setTimeout(()=>{s.style.animation="slideOut 0.3s ease",setTimeout(()=>s.remove(),300)},3e3)}function createMessageElement(e,t,s,n,o,r){let a=document.createElement("div");a.className=s?"message user":"message receiver",r&&(a.dataset.messageId=r,state.lastMessageId=r);let i=document.createElement("div");if(i.className="message-content",state.roomUsers.length>2){if(s)a.style.backgroundColor="#007bff";else{let l=assignUserColor(e);a.style.backgroundColor=l}if(!state.displayedUsernames.has(e)||s){let d=document.createElement("span");d.className="message-username",d.style.cssText=`
        font-weight: bold;
        font-size: 11px;
        margin-bottom: 4px;
        display: block;
        font-family: Poppins, sans-serif;
        color: #ffffff;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      `,d.textContent=sanitizeInput(e),i.appendChild(d),state.displayedUsernames.add(e),setTimeout(()=>{state.displayedUsernames.delete(e)},CONFIG.usernameDisplayTimeout)}}if(o){let c=document.createElement("img");c.src=sanitizeInput(o),c.alt="User uploaded image",c.style.cssText="max-width: 200px; border-radius: 8px; cursor: pointer;",c.onclick=()=>window.open(o,"_blank"),i.appendChild(c)}else if(t){let m=document.createElement("div"),g=decryptMessage(t);m.textContent=g||"[Message could not be decrypted]",g||(m.style.fontStyle="italic",m.style.opacity="0.6"),i.appendChild(m)}if(n){let u=document.createElement("span");u.className="message-time",u.style.cssText=`
      font-size: 9px;
      color: #b8b8b8;
      margin-top: 3px;
      display: block;
      text-align: ${s?"right":"left"};
      font-family: Poppins, sans-serif;
      font-weight: 500;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    `;let p=new Date(n),y=new Date,f=p.toDateString()===y.toDateString()?p.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):p.toLocaleDateString()+" "+p.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});u.textContent=f,i.appendChild(u),a.dataset.timestamp=n}return a.appendChild(i),a}function showSeenStatus(e,t){let s=document.querySelector(`[data-message-id="${e}"]`);if(!s)return;document.querySelectorAll(".seen-indicator").forEach(e=>e.remove());let n=t.filter(e=>e!==state.currentUser),o=s.classList.contains("user");if(n.length>0&&o&&e===state.lastMessageId){let r=document.createElement("div");r.className="seen-indicator",r.style.cssText=`
      font-size: 10px;
      color: #007bff;
      text-align: right;
      margin-top: 2px;
      margin-bottom: 5px;
      margin-right: 10px;
      font-style: italic;
      font-family: Poppins, sans-serif;
      font-weight: 500;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
      align-self: flex-end;
    `;let a=[...new Set(n)];r.textContent=1===a.length?`âœ“ Seen by ${sanitizeInput(a[0])}`:`âœ“ Seen by ${a.map(sanitizeInput).join(", ")}`,s.parentNode.insertBefore(r,s.nextSibling)}}function markMessagesAsSeen(){state.isJoined&&state.currentRoomId&&state.lastMessageId&&socket.emit("markAllSeen",{roomId:state.currentRoomId})}function handleImageUpload(e){let t=e.target.files[0],s=document.getElementById("imageUploadLabel");if(!t)return;if(!state.isJoined){showNotification("Please join a room first","error"),e.target.value="";return}if(t.size>CONFIG.maxFileSize){showNotification(`File too large. Max size is ${CONFIG.maxFileSize/1024/1024}MB`,"error"),e.target.value="";return}if(!t.type.startsWith("image/")){showNotification("Only image files are allowed","error"),e.target.value="";return}s.textContent=`ðŸ“· Uploading...`;let n=new FormData;n.append("image",t),n.append("roomId",state.currentRoomId),n.append("username",state.currentUser),fetch("/upload",{method:"POST",body:n}).then(e=>e.json()).then(e=>{e.success?showNotification("Image uploaded successfully","info"):showNotification("Upload failed: "+(e.error||"Unknown error"),"error")}).catch(e=>{console.error("Upload error:",e),showNotification("Upload failed. Please try again.","error")}).finally(()=>{s.textContent="\uD83D\uDCF7",e.target.value=""})}function sendMessage(){if(!state.isJoined){console.warn("Cannot send message: not joined to a room");return}let e=document.getElementById("message"),t=e.value.trim();if(!t)return;if(t.length>CONFIG.maxMessageLength){showNotification(`Message too long. Max ${CONFIG.maxMessageLength} characters.`,"error");return}let s=encryptMessage(t);if(!s){showNotification("Failed to encrypt message","error");return}socket.emit("chatMessage",{roomId:state.currentRoomId,message:s}),e.value="",socket.emit("stopTyping",state.currentRoomId)}function handleTyping(){state.isJoined&&state.currentRoomId&&(socket.emit("typing",state.currentRoomId),clearTimeout(state.typingTimeout),state.typingTimeout=setTimeout(()=>{socket.emit("stopTyping",state.currentRoomId)},CONFIG.typingDebounce))}function joinRoom(){if(!validateInputs()){showNotification("Please enter valid username (2-50 chars) and room ID","error");return}let e=document.getElementById("username").value.trim(),t=document.getElementById("roomId").value.trim();state.currentUser=e,state.currentRoomId=t,socket.emit("joinRoom",{username:e,roomId:t}),document.getElementById("join").disabled=!0,document.getElementById("join").textContent="Joining..."}socket.on("connect",()=>{console.log("Connected to server"),state.currentUser&&state.currentRoomId&&!state.isJoined&&(console.log("Reconnecting to room..."),socket.emit("joinRoom",{username:state.currentUser,roomId:state.currentRoomId}))}),socket.on("disconnect",e=>{console.log("Disconnected from server:",e),state.isJoined=!1,state.displayedUsernames.clear(),showNotification("Disconnected from server. Attempting to reconnect...","error"),document.getElementById("login-form").style.display="block",document.getElementById("chat-container").style.display="none",document.getElementById("join").disabled=!1,document.getElementById("join").textContent="Join"}),socket.on("joinConfirmed",({username:e,roomId:t,users:s})=>{console.log("Successfully joined room:",t),state.isJoined=!0,state.roomUsers=s.map(e=>e.username)||[],state.userColors={},state.displayedUsernames.clear(),document.getElementById("login-form").style.display="none",document.getElementById("chat-container").style.display="flex",showNotification(`Joined room: ${t}`,"info"),setTimeout(markMessagesAsSeen,CONFIG.seenDebounce)}),socket.on("joinError",e=>{console.error("Failed to join room:",e),showNotification(e,"error"),document.getElementById("join").disabled=!1,document.getElementById("join").textContent="Join"}),socket.on("connectionError",e=>{showNotification(e,"error")}),socket.on("error",e=>{showNotification(e,"error")}),socket.on("previousMessages",e=>{let t=document.getElementById("messages");t.innerHTML="",state.displayedUsernames.clear(),e.forEach(({username:e,message:s,timestamp:n,imageUrl:o,messageId:r})=>{let a=createMessageElement(e,s,e===state.currentUser,n,o,r);t.appendChild(a)}),scrollToBottom()}),socket.on("olderMessages",e=>{let t=document.getElementById("messages"),s=t.scrollHeight;e.reverse().forEach(({username:e,message:s,timestamp:n,imageUrl:o,messageId:r})=>{let a=createMessageElement(e,s,e===state.currentUser,n,o,r);t.insertBefore(a,t.firstChild)}),t.scrollTop=t.scrollHeight-s,state.isLoadingMoreMessages=!1}),socket.on("chatMessage",({user:e,message:t,imageUrl:s,messageId:n,timestamp:o})=>{let r=createMessageElement(e,t,e===state.currentUser,o,s,n);document.getElementById("messages").appendChild(r),state.autoScrollEnabled&&scrollToBottom(),e!==state.currentUser&&setTimeout(markMessagesAsSeen,CONFIG.seenDebounce)}),socket.on("messageSeen",({messageId:e,seenBy:t})=>{showSeenStatus(e,t)}),socket.on("typing",e=>{if(!e||e===state.currentUser)return;let t=document.getElementById("messages"),s=t.querySelector(".typing-indicator");s&&s.remove();let n=document.createElement("div");n.className="typing-indicator",n.textContent=`${sanitizeInput(e)} is typing...`,n.style.cssText=`
    font-style: italic;
    color: #888;
    padding: 10px;
    font-size: 12px;
  `,t.appendChild(n),state.autoScrollEnabled&&scrollToBottom()}),socket.on("stopTyping",()=>{let e=document.querySelector(".typing-indicator");e&&e.remove()}),socket.on("updateActiveUsers",e=>{let t=[...new Set(e.map(e=>e.username))];state.roomUsers=t;let s=t.filter(e=>e!==state.currentUser).map(sanitizeInput).join(", ");document.getElementById("active-users").textContent=`Active Users: ${s||"None"}`}),document.getElementById("join").addEventListener("click",joinRoom),document.getElementById("username").addEventListener("input",validateInputs),document.getElementById("roomId").addEventListener("input",validateInputs),document.getElementById("username").addEventListener("keydown",e=>{"Enter"===e.key&&joinRoom()}),document.getElementById("roomId").addEventListener("keydown",e=>{"Enter"===e.key&&joinRoom()}),document.getElementById("send").addEventListener("click",sendMessage),document.getElementById("message").addEventListener("keydown",e=>{"Enter"===e.key&&(sendMessage(),e.preventDefault())}),document.getElementById("message").addEventListener("input",handleTyping),document.getElementById("imageUpload").addEventListener("change",handleImageUpload),document.getElementById("messages").addEventListener("scroll",()=>{let e=document.getElementById("messages");if(0===e.scrollTop&&!state.isLoadingMoreMessages&&state.isJoined){state.isLoadingMoreMessages=!0;let t=e.firstChild?.dataset?.timestamp;t?socket.emit("loadMoreMessages",{roomId:state.currentRoomId,oldestMessageTimestamp:t}):state.isLoadingMoreMessages=!1}let s=e.scrollHeight-e.scrollTop<=e.clientHeight+5;state.autoScrollEnabled=s,s&&markMessagesAsSeen()}),window.addEventListener("focus",()=>{state.isJoined&&markMessagesAsSeen()}),scrollToBottom();
