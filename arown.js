const socket=io();let autoScrollEnabled=!0,isLoadingMoreMessages=!1,SECRET_KEY="xSAjwEE70Ilu4EN6iM1yTB-9A6ut4OfWDVmlZi82Q_w=",currentUser=null,currentRoomId=null,isJoined=!1;function setSecretKey(e){SECRET_KEY=e}function encryptMessage(e){let t=CryptoJS.lib.WordArray.random(16),n=CryptoJS.AES.encrypt(e,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:t});return t.toString()+":"+n.toString()}function decryptMessage(e){let t=e.split(":");if(2!==t.length)return console.error("Invalid ciphertext format"),null;let n=CryptoJS.enc.Hex.parse(t[0]),o=t[1],s=CryptoJS.AES.decrypt(o,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:n}).toString(CryptoJS.enc.Utf8);return s||console.warn("Decryption failed for message:",e),s}function validateInputs(){let e=document.getElementById("username").value.trim(),t=document.getElementById("roomId").value.trim(),n=/^[a-zA-Z0-9]{4,20}$/.test(e);document.getElementById("username").style.backgroundColor=n?"lightgreen":"lightcoral";let o=/^\d{1,5}$/.test(t);return document.getElementById("roomId").style.backgroundColor=o?"lightgreen":"lightcoral",n&&o}function scrollToBottom(){let e=document.getElementById("messages");e.scrollTop=e.scrollHeight}function createMessageElement(e,t,n,o,s){let r=document.createElement("div");if(r.className=n?"message user":"message receiver",s){let l=document.createElement("img");l.src=s,l.alt="User uploaded image",l.style.maxWidth="200px",r.appendChild(l)}else{let i=decryptMessage(t);r.innerText=i,i||(console.warn("Decryption failed for message:",t),r.innerText="[Message could not be decrypted]")}return o&&(r.dataset.timestamp=o),r}document.getElementById("join").addEventListener("click",()=>{if(validateInputs()){let e=document.getElementById("username").value.trim(),t=document.getElementById("roomId").value.trim();currentUser=e,currentRoomId=t,socket.emit("joinRoom",{username:e,roomId:t}),document.getElementById("join").disabled=!0,document.getElementById("join").textContent="Joining..."}else alert("Login failed: Please enter valid username and room ID.")}),socket.on("joinConfirmed",({username:e,roomId:t})=>{console.log("Successfully joined room:",t),isJoined=!0,document.getElementById("login-form").style.display="none",document.getElementById("chat-container").style.display="flex"}),socket.on("joinError",e=>{console.error("Failed to join room:",e),alert("Failed to join room: "+e),document.getElementById("join").disabled=!1,document.getElementById("join").textContent="Join"}),socket.on("previousMessages",e=>{console.log("Received previous messages:",e);let t=document.getElementById("messages");t.innerHTML="",e.forEach(({username:e,message:n,timestamp:o,imageUrl:s})=>{let r=createMessageElement(e,n,e===currentUser,o,s);t.appendChild(r)}),scrollToBottom()}),socket.on("olderMessages",e=>{let t=document.getElementById("messages"),n=t.scrollHeight;e.forEach(({username:e,message:n,timestamp:o,imageUrl:s})=>{let r=createMessageElement(e,n,e===currentUser,o,s);t.insertBefore(r,t.firstChild)}),t.scrollTop=t.scrollHeight-n,isLoadingMoreMessages=!1}),socket.on("chatMessage",({user:e,message:t,imageUrl:n})=>{if(n){let o=createMessageElement(e,null,e===currentUser,null,n);document.getElementById("messages").appendChild(o)}else{let s=createMessageElement(e,t,e===currentUser,null);document.getElementById("messages").appendChild(s)}autoScrollEnabled&&scrollToBottom()}),document.getElementById("imageUpload").addEventListener("change",function(){let e=document.getElementById("imageUploadLabel"),t=this.files[0];if(t&&isJoined){e.textContent=`ðŸ“· ${t.name}`;let n=new FileReader;n.onload=function(n){let o=n.target.result;socket.emit("imageUpload",{roomId:currentRoomId,file:{name:t.name,data:o}}),document.getElementById("imageUpload").value="",e.textContent="\uD83D\uDCF7"},n.readAsArrayBuffer(t)}else isJoined?e.textContent="\uD83D\uDCF7":(alert("Please join a room first"),this.value="")});let typingTimeout;function sendMessage(){if(!isJoined){console.warn("Cannot send message: not joined to a room");return}let e=document.getElementById("message"),t=e.value.trim();if(t){let n=encryptMessage(t);socket.emit("chatMessage",{roomId:currentRoomId,message:n}),e.value="",socket.emit("stopTyping",currentRoomId)}}document.getElementById("message").addEventListener("input",()=>{isJoined&&currentRoomId&&(socket.emit("typing",currentRoomId),clearTimeout(typingTimeout),typingTimeout=setTimeout(()=>{socket.emit("stopTyping",currentRoomId)},1e3))}),document.getElementById("send").addEventListener("click",sendMessage),document.getElementById("message").addEventListener("keydown",e=>{"Enter"===e.key&&(sendMessage(),e.preventDefault())}),socket.on("typing",e=>{if(!e||e===currentUser)return;let t=document.getElementById("messages");if(!t.querySelector(".typing-indicator")){let n=document.createElement("div");n.className="typing-indicator",n.innerText=`${e} is typing...`,t.appendChild(n),autoScrollEnabled&&scrollToBottom()}}),socket.on("stopTyping",()=>{let e=document.querySelector(".typing-indicator");e&&e.remove()}),socket.on("updateActiveUsers",e=>{let t=e.filter(e=>e.username!==currentUser).map(e=>e.username).join(", ");document.getElementById("active-users").innerHTML="Active Users: "+(t||"None")}),document.getElementById("messages").addEventListener("scroll",()=>{let e=document.getElementById("messages");if(0===e.scrollTop&&!isLoadingMoreMessages&&isJoined){isLoadingMoreMessages=!0;let t=e.firstChild?.dataset?.timestamp;t?socket.emit("loadMoreMessages",{roomId:currentRoomId,oldestMessageTimestamp:t}):isLoadingMoreMessages=!1}autoScrollEnabled=e.scrollHeight-e.scrollTop<=e.clientHeight+5}),socket.on("connect",()=>{console.log("Connected to server")}),socket.on("disconnect",e=>{console.log("Disconnected from server:",e),isJoined=!1,document.getElementById("login-form").style.display="block",document.getElementById("chat-container").style.display="none",document.getElementById("join").disabled=!1,document.getElementById("join").textContent="Join"}),socket.on("connect",()=>{currentUser&&currentRoomId&&!isJoined&&(console.log("Reconnecting to room..."),socket.emit("joinRoom",{username:currentUser,roomId:currentRoomId}))}),scrollToBottom();
