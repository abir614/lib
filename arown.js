const socket=io();let autoScrollEnabled=!0,isLoadingMoreMessages=!1,SECRET_KEY="xSAjwEE70Ilu4EN6iM1yTB-9A6ut4OfWDVmlZi82Q_w=",currentUser=null,currentRoomId=null,isJoined=!1,userColors={},roomUsers=[],lastMessageId=null,displayedUsernames=new Set;const USER_COLORS=["#28a745","#dc3545","#ffc107","#6f42c1","#fd7e14","#20c997","#e83e8c","#6c757d","#17a2b8"];function setSecretKey(e){SECRET_KEY=e}function encryptMessage(e){let t=CryptoJS.lib.WordArray.random(16),s=CryptoJS.AES.encrypt(e,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:t});return t.toString()+":"+s.toString()}function decryptMessage(e){let t=e.split(":");if(2!==t.length)return console.error("Invalid ciphertext format"),null;let s=CryptoJS.enc.Hex.parse(t[0]),n=t[1],o=CryptoJS.AES.decrypt(n,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:s}).toString(CryptoJS.enc.Utf8);return o||console.warn("Decryption failed for message:",e),o}function validateInputs(){let e=document.getElementById("username").value.trim(),t=document.getElementById("roomId").value.trim(),s=/^[a-zA-Z0-9]{4,20}$/.test(e);document.getElementById("username").style.backgroundColor=s?"lightgreen":"lightcoral";let n=/^\d{1,5}$/.test(t);return document.getElementById("roomId").style.backgroundColor=n?"lightgreen":"lightcoral",s&&n}function scrollToBottom(){let e=document.getElementById("messages");e.scrollTop=e.scrollHeight}function assignUserColor(e){if(!userColors[e]){let t=Object.keys(userColors).length%USER_COLORS.length;userColors[e]=USER_COLORS[t]}return userColors[e]}function createMessageElement(e,t,s,n,o,r){let l=document.createElement("div");l.className=s?"message user":"message receiver",r&&(l.dataset.messageId=r,lastMessageId=r);let a=document.createElement("div");if(a.className="message-content",roomUsers.length>2){if(s)l.style.backgroundColor="#007bff";else{let i=assignUserColor(e);l.style.backgroundColor=i}if(!displayedUsernames.has(e)||s){let d=document.createElement("span");d.className="message-username",d.style.fontWeight="bold",d.style.fontSize="11px",d.style.opacity="1",d.style.marginBottom="4px",d.style.display="block",d.style.fontFamily="Poppins, sans-serif",d.style.color="#ffffff",d.style.textShadow="1px 1px 2px rgba(0,0,0,0.5)",d.textContent=e,a.appendChild(d),displayedUsernames.add(e),setTimeout(()=>{displayedUsernames.delete(e)},1e4)}}if(o){let m=document.createElement("img");m.src=o,m.alt="User uploaded image",m.style.maxWidth="200px",m.style.borderRadius="8px",a.appendChild(m)}else{let c=document.createElement("div"),g=decryptMessage(t);c.textContent=g||"[Message could not be decrypted]",g||console.warn("Decryption failed for message:",t),a.appendChild(c)}if(n){let y=document.createElement("span");y.className="message-time",y.style.fontSize="9px",y.style.color="#b8b8b8",y.style.marginTop="3px",y.style.display="block",y.style.opacity="1",y.style.textAlign=s?"right":"left",y.style.fontFamily="Poppins, sans-serif",y.style.fontWeight="500",y.style.textShadow="1px 1px 2px rgba(0,0,0,0.7)";let u=new Date(n),p=new Date,f;f=u.toDateString()===p.toDateString()?u.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):u.toLocaleDateString()+" "+u.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),y.textContent=f,a.appendChild(y)}return l.appendChild(a),n&&(l.dataset.timestamp=n),l}function updateSeenIndicator(){document.querySelectorAll(".seen-indicator").forEach(e=>e.remove())}function showSeenStatus(e,t){let s=document.querySelector(`[data-message-id="${e}"]`);if(!s)return;document.querySelectorAll(".seen-indicator").forEach(e=>e.remove());let n=t.filter(e=>e!==currentUser),o=s.classList.contains("user");if(n.length>0&&o&&e===lastMessageId){let r=document.createElement("div");r.className="seen-indicator",r.style.fontSize="10px",r.style.color="#007bff",r.style.textAlign="right",r.style.marginTop="2px",r.style.marginBottom="5px",r.style.marginRight="10px",r.style.fontStyle="italic",r.style.fontFamily="Poppins, sans-serif",r.style.opacity="1",r.style.fontWeight="500",r.style.textShadow="1px 1px 2px rgba(0,0,0,0.7)",r.style.alignSelf="flex-end";let l=[...new Set(n)];1===l.length?r.textContent=`âœ“ Seen by ${l[0]}`:r.textContent=`âœ“ Seen by ${l.join(", ")}`,s.parentNode.insertBefore(r,s.nextSibling)}}function markMessagesAsSeen(){isJoined&&currentRoomId&&lastMessageId&&socket.emit("markAllSeen",{roomId:currentRoomId})}document.getElementById("join").addEventListener("click",()=>{if(validateInputs()){let e=document.getElementById("username").value.trim(),t=document.getElementById("roomId").value.trim();currentUser=e,currentRoomId=t,socket.emit("joinRoom",{username:e,roomId:t}),document.getElementById("join").disabled=!0,document.getElementById("join").textContent="Joining..."}else alert("Login failed: Please enter valid username and room ID.")}),socket.on("joinConfirmed",({username:e,roomId:t,users:s})=>{console.log("Successfully joined room:",t),isJoined=!0,roomUsers=s||[],userColors={},displayedUsernames.clear(),document.getElementById("login-form").style.display="none",document.getElementById("chat-container").style.display="flex",setTimeout(markMessagesAsSeen,1e3)}),socket.on("joinError",e=>{console.error("Failed to join room:",e),e.includes("already exists")?alert("Username already taken in this room.\nPlease choose a different username."):alert("Failed to join room: "+e),document.getElementById("join").disabled=!1,document.getElementById("join").textContent="Join"}),socket.on("previousMessages",e=>{console.log("Received previous messages:",e);let t=document.getElementById("messages");t.innerHTML="",displayedUsernames.clear(),e.forEach(({username:e,message:s,timestamp:n,imageUrl:o,messageId:r})=>{let l=createMessageElement(e,s,e===currentUser,n,o,r);t.appendChild(l)}),scrollToBottom()}),socket.on("olderMessages",e=>{let t=document.getElementById("messages"),s=t.scrollHeight;e.forEach(({username:e,message:s,timestamp:n,imageUrl:o,messageId:r})=>{let l=createMessageElement(e,s,e===currentUser,n,o,r);t.insertBefore(l,t.firstChild)}),t.scrollTop=t.scrollHeight-s,isLoadingMoreMessages=!1}),socket.on("chatMessage",({user:e,message:t,imageUrl:s,messageId:n,timestamp:o})=>{let r;r=s?createMessageElement(e,null,e===currentUser,o,s,n):createMessageElement(e,t,e===currentUser,o,null,n),document.getElementById("messages").appendChild(r),autoScrollEnabled&&scrollToBottom(),e!==currentUser&&setTimeout(markMessagesAsSeen,500)}),socket.on("messageSeen",({messageId:e,seenBy:t})=>{showSeenStatus(e,t)}),document.getElementById("imageUpload").addEventListener("change",function(){let e=document.getElementById("imageUploadLabel"),t=this.files[0];if(t&&isJoined){e.textContent=`ðŸ“· ${t.name}`;let s=new FileReader;s.onload=function(s){let n=s.target.result;socket.emit("imageUpload",{roomId:currentRoomId,file:{name:t.name,data:n}}),document.getElementById("imageUpload").value="",e.textContent="\uD83D\uDCF7"},s.readAsArrayBuffer(t)}else isJoined?e.textContent="\uD83D\uDCF7":(alert("Please join a room first"),this.value="")});let typingTimeout;function sendMessage(){if(!isJoined){console.warn("Cannot send message: not joined to a room");return}let e=document.getElementById("message"),t=e.value.trim();if(t){let s=encryptMessage(t);socket.emit("chatMessage",{roomId:currentRoomId,message:s}),e.value="",socket.emit("stopTyping",currentRoomId)}}document.getElementById("message").addEventListener("input",()=>{isJoined&&currentRoomId&&(socket.emit("typing",currentRoomId),clearTimeout(typingTimeout),typingTimeout=setTimeout(()=>{socket.emit("stopTyping",currentRoomId)},1e3))}),document.getElementById("send").addEventListener("click",sendMessage),document.getElementById("message").addEventListener("keydown",e=>{"Enter"===e.key&&(sendMessage(),e.preventDefault())}),socket.on("typing",e=>{if(!e||e===currentUser)return;let t=document.getElementById("messages");if(!t.querySelector(".typing-indicator")){let s=document.createElement("div");s.className="typing-indicator",s.innerText=`${e} is typing...`,t.appendChild(s),autoScrollEnabled&&scrollToBottom()}}),socket.on("stopTyping",()=>{let e=document.querySelector(".typing-indicator");e&&e.remove()}),socket.on("updateActiveUsers",e=>{let t=[...new Set(e.map(e=>e.username))];roomUsers=t;let s=t.filter(e=>e!==currentUser).join(", ");document.getElementById("active-users").innerHTML="Active Users: "+(s||"None")}),document.getElementById("messages").addEventListener("scroll",()=>{let e=document.getElementById("messages");if(0===e.scrollTop&&!isLoadingMoreMessages&&isJoined){isLoadingMoreMessages=!0;let t=e.firstChild?.dataset?.timestamp;t?socket.emit("loadMoreMessages",{roomId:currentRoomId,oldestMessageTimestamp:t}):isLoadingMoreMessages=!1}let s=e.scrollHeight-e.scrollTop<=e.clientHeight+5;autoScrollEnabled=s,s&&markMessagesAsSeen()}),window.addEventListener("focus",()=>{isJoined&&markMessagesAsSeen()}),socket.on("connect",()=>{console.log("Connected to server")}),socket.on("disconnect",e=>{console.log("Disconnected from server:",e),isJoined=!1,displayedUsernames.clear(),document.getElementById("login-form").style.display="block",document.getElementById("chat-container").style.display="none",document.getElementById("join").disabled=!1,document.getElementById("join").textContent="Join"}),socket.on("connect",()=>{currentUser&&currentRoomId&&!isJoined&&(console.log("Reconnecting to room..."),socket.emit("joinRoom",{username:currentUser,roomId:currentRoomId}))}),scrollToBottom();
