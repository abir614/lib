const socket=io();let state={currentUser:null,currentRoomId:null,isJoined:!1,autoScrollEnabled:!0,isLoadingMoreMessages:!1,lastMessageId:null,roomUsers:[],userColors:{},displayedUsernames:new Set(),typingTimeout:null,joinTimeout:null,seenTimeout:null,typingUsers:new Set(),};const USER_COLORS=["#28a745","#dc3545","#ffc107","#6f42c1","#fd7e14","#20c997","#e83e8c","#6c757d","#17a2b8"];const CONFIG={maxMessageLength:2000,maxFileSize:5*1024*1024,typingDebounce:1000,seenDebounce:500,usernameDisplayTimeout:10000};const SECRET_KEY="xSAjwEE70Ilu4EN6iM1yTB-9A6ut4OfWDVmlZi82Q_w=";function encryptMessage(message){try{const iv=CryptoJS.lib.WordArray.random(16);const encrypted=CryptoJS.AES.encrypt(message,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:iv});return iv.toString()+":"+encrypted.toString()}catch(error){console.error("Encryption error:",error);return null}}
function decryptMessage(ciphertext){try{if(!ciphertext||typeof ciphertext!=='string'||!ciphertext.includes(":")){return ciphertext}
const parts=ciphertext.split(":");if(parts.length!==2){return ciphertext}
const iv=CryptoJS.enc.Hex.parse(parts[0]);const encrypted=parts[1];const decrypted=CryptoJS.AES.decrypt(encrypted,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:iv}).toString(CryptoJS.enc.Utf8);return decrypted||ciphertext}catch(error){console.error("Decryption error:",error);return ciphertext}}
function validateUsername(username){return/^[a-zA-Z0-9_-]{2,50}$/.test(username)}
function validateRoomId(roomId){return/^[a-zA-Z0-9_-]{1,100}$/.test(roomId)}
function validateInputs(){const username=document.getElementById("username").value.trim();const roomId=document.getElementById("roomId").value.trim();const usernameValid=validateUsername(username);const roomIdValid=validateRoomId(roomId);const usernameInput=document.getElementById("username");const roomIdInput=document.getElementById("roomId");if(usernameInput){usernameInput.style.borderColor=usernameValid?"":"#dc3545"}
if(roomIdInput){roomIdInput.style.borderColor=roomIdValid?"":"#dc3545"}
const joinButton=document.getElementById('join');if(joinButton&&socket.connected){joinButton.disabled=!(usernameValid&&roomIdValid);if(joinButton.disabled){joinButton.textContent="Enter Info"}else{joinButton.innerHTML='<span>Join Chat</span><i class="fas fa-arrow-right"></i>'}}
return usernameValid&&roomIdValid}
function sanitizeInput(input){const div=document.createElement('div');div.textContent=input;return div.innerHTML}
function scrollToBottom(){const messagesContainer=document.getElementById("messages");if(messagesContainer){messagesContainer.scrollTop=messagesContainer.scrollHeight}}
function assignUserColor(username){if(!state.userColors[username]){const colorIndex=Object.keys(state.userColors).length%USER_COLORS.length;state.userColors[username]=USER_COLORS[colorIndex]}
return state.userColors[username]}
function showNotification(message,type="info"){const notification=document.createElement("div");notification.className=`notification ${type}`;notification.textContent=message;notification.style.cssText=`
position: fixed;
top: 20px;
right: 20px;
padding: 15px 20px;
background: ${type === "error" ? "#dc3545" : "#28a745"};
color: white;
border-radius: 5px;
z-index: 10000;
animation: slideIn 0.3s ease;
box-shadow: 0 4px 12px rgba(0,0,0,0.2);
`;document.body.appendChild(notification);setTimeout(()=>{notification.style.animation="slideOut 0.3s ease";setTimeout(()=>notification.remove(),300)},3000)}
function updateConnectionStatus(isConnected){const statusDot=document.querySelector(".connection-status .status-dot");const statusText=document.querySelector(".connection-status .status-text");const joinButton=document.getElementById('join');if(isConnected){if(statusDot)statusDot.className="status-dot connected";if(statusText)statusText.textContent="Connected";if(joinButton){if(validateInputs()){joinButton.disabled=!1;joinButton.innerHTML='<span>Join Chat</span><i class="fas fa-arrow-right"></i>'}else{joinButton.disabled=!0;joinButton.textContent="Enter Info"}}}else{if(statusDot)statusDot.className="status-dot";if(statusText)statusText.textContent="Connecting...";if(joinButton){joinButton.disabled=!0;joinButton.textContent="Connecting..."}}}
function updateActiveUsersDisplay(){const activeUsersElement=document.getElementById("active-users");if(!activeUsersElement)return;const otherUsers=state.roomUsers.map(u=>u.username).filter(username=>username!==state.currentUser);const count=otherUsers.length;let text;if(count===0){text="You are alone in the room"}else if(count===1){text=`Active: ${sanitizeInput(otherUsers[0])}`}else if(count<=3){text=`Active: ${otherUsers.map(sanitizeInput).join(', ')}`}else{text=`${count} active users`}
activeUsersElement.textContent=text}
function updateTypingIndicator(){const indicator=document.getElementById("typing-indicator");if(!indicator)return;const typers=Array.from(state.typingUsers).filter(u=>u!==state.currentUser&&u!=='System');if(typers.length===0){indicator.style.display='none';indicator.innerHTML=''}else{let text;if(typers.length===1){text=`${sanitizeInput(typers[0])} is typing`}else if(typers.length===2){text=`${sanitizeInput(typers[0])} and ${sanitizeInput(typers[1])} are typing`}else{text=`${typers.length} users are typing`}
indicator.innerHTML=`${text}<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>`;indicator.style.display='flex'}}
async function handleScroll(){const messagesContainer=document.getElementById("messages");if(!messagesContainer||messagesContainer.scrollHeight===messagesContainer.clientHeight)return;const isNearTop=messagesContainer.scrollTop<100;if(isNearTop&&state.isJoined&&!state.isLoadingMoreMessages&&state.lastMessageId){state.isLoadingMoreMessages=!0;const loadingIndicator=document.getElementById("loading-indicator");if(loadingIndicator)loadingIndicator.classList.remove('hidden');try{const url=`/api/messages/${state.currentRoomId}?before=${state.lastMessageId}&limit=20`;const response=await fetch(url);const data=await response.json();if(data.messages&&data.messages.length>0){const messagesToPrepend=data.messages;const oldScrollHeight=messagesContainer.scrollHeight;messagesToPrepend.forEach(msg=>{const seenStatus=msg.seenBy&&msg.seenBy.length>=2&&msg.username===state.currentUser;const messageElement=createMessageElement(msg.username,msg.message,msg.username===state.currentUser,msg.timestamp,msg.imageUrl,msg.messageId,seenStatus);messagesContainer.insertBefore(messageElement,loadingIndicator.nextSibling);state.lastMessageId=msg.messageId});const newScrollHeight=messagesContainer.scrollHeight;messagesContainer.scrollTop=newScrollHeight-oldScrollHeight;if(data.messages.length<20){state.lastMessageId=null;showNotification("Start of conversation reached.","info")}}else{state.lastMessageId=null}}catch(error){console.error("Failed to load older messages:",error);showNotification("Failed to load older messages.","error")}finally{state.isLoadingMoreMessages=!1;if(loadingIndicator)loadingIndicator.classList.add('hidden');}}}
function downloadChatHistory(){if(!state.isJoined){showNotification("Please join a room before downloading history.","error");return}
const messagesContainer=document.getElementById("messages");if(!messagesContainer)return;const messageElements=messagesContainer.querySelectorAll('.message:not(.hidden)');const history=[];messageElements.forEach(el=>{const usernameEl=el.querySelector('.message-username');let username;if(el.classList.contains('user')){username=state.currentUser}else{username=usernameEl?.textContent||'Unknown User'}
const text=el.querySelector('.message-text')?.textContent||"";const timestamp=el.dataset.timestamp;const imageUrl=el.querySelector('img')?.src||"";const messageId=el.dataset.messageId;history.push({id:messageId,user:username,message:text,imageUrl:imageUrl,timestamp:timestamp?new Date(timestamp).toISOString():new Date().toISOString()})});if(history.length===0){showNotification("No messages to download.","info");return}
const jsonString=JSON.stringify(history,null,2);const blob=new Blob([jsonString],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`SecureChat_History_${state.currentRoomId}_${new Date().toISOString().substring(0, 10)}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);showNotification("Chat history prepared for download.","info")}
function createMessageElement(username,message,isCurrentUser,timestamp,imageUrl,messageId,seenStatus=!1){const messageElement=document.createElement("div");messageElement.className=isCurrentUser?"message user":"message receiver";if(messageId){messageElement.dataset.messageId=messageId;if(messageElement.previousElementSibling?.id==='loading-indicator'||!messageElement.previousElementSibling){state.lastMessageId=messageId}}
const contentElement=document.createElement("div");contentElement.className="message-content";if(!isCurrentUser){const userColor=assignUserColor(username);messageElement.style.backgroundColor=userColor;const usernameElement=document.createElement("span");usernameElement.className="message-username";usernameElement.textContent=sanitizeInput(username);contentElement.appendChild(usernameElement)}
if(imageUrl){const imgElement=document.createElement("img");imgElement.src=sanitizeInput(imageUrl);imgElement.alt="User uploaded image";imgElement.style.cssText="max-width: 100%; max-height: 300px; border-radius: 8px; cursor: pointer; margin: 5px 0;";imgElement.onclick=()=>window.open(imageUrl,"_blank");contentElement.appendChild(imgElement)}else if(message){const messageText=document.createElement("div");messageText.className="message-text";messageText.style.cssText="word-wrap: break-word; white-space: pre-wrap;";const decryptedMessage=decryptMessage(message);messageText.textContent=decryptedMessage;contentElement.appendChild(messageText)}
if(timestamp){const timeElement=document.createElement("span");timeElement.className="message-time";const messageDate=new Date(timestamp);const now=new Date();let formattedTime;if(messageDate.toDateString()===now.toDateString()){formattedTime=messageDate.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}else if(messageDate.getFullYear()===now.getFullYear()){formattedTime=messageDate.toLocaleDateString([],{month:'short',day:'numeric'})}else{formattedTime=messageDate.toLocaleDateString()}
timeElement.textContent=formattedTime;if(isCurrentUser&&seenStatus){const seenElement=document.createElement('i');seenElement.className='fas fa-check-double seen-status';timeElement.appendChild(seenElement);messageElement.classList.add('seen')}
contentElement.appendChild(timeElement);messageElement.dataset.timestamp=timestamp}
messageElement.appendChild(contentElement);return messageElement}
function joinRoom(){if(!validateInputs()){showNotification("Please enter valid username (2-50 chars) and room ID","error");return}
const username=document.getElementById("username").value.trim();const roomId=document.getElementById("roomId").value.trim();const joinButton=document.getElementById('join');if(joinButton){joinButton.disabled=!0;joinButton.textContent="Joining..."}
state.currentUser=username;state.currentRoomId=roomId;console.log("Attempting to join room:",roomId);socket.emit("joinRoom",{username,roomId});state.joinTimeout=setTimeout(()=>{if(!state.isJoined){showNotification("Connection timeout. Please try again.","error");if(joinButton){joinButton.disabled=!1;joinButton.innerHTML='<span>Join Chat</span><i class="fas fa-arrow-right"></i>'}}},10000)}
socket.on("connect",()=>{console.log("Connected to server with ID:",socket.id);updateConnectionStatus(!0);if(state.currentUser&&state.currentRoomId&&!state.isJoined){console.log("Reconnecting to room...");socket.emit("joinRoom",{username:state.currentUser,roomId:state.currentRoomId})}});socket.on("disconnect",(reason)=>{console.log("Disconnected from server:",reason);state.isJoined=!1;state.displayedUsernames.clear();state.typingUsers.clear();updateConnectionStatus(!1);updateTypingIndicator()});socket.on("connectionError",({message})=>{console.error("Connection error:",message);updateConnectionStatus(!1);showNotification("Connection error: "+message,"error")});socket.on("error",(message)=>{console.error("Server Error:",message);showNotification("Server Error: "+message,"error")});socket.on("joinConfirmed",({username,roomId,users})=>{clearTimeout(state.joinTimeout);state.isJoined=!0;state.roomUsers=users;document.getElementById("room-display").textContent=sanitizeInput(roomId);document.querySelector('.login-container').style.display='none';document.getElementById('chat-container').style.display='flex';updateActiveUsersDisplay();scrollToBottom()});socket.on("joinError",(message)=>{clearTimeout(state.joinTimeout);state.isJoined=!1;updateConnectionStatus(socket.connected);showNotification("Join failed: "+message,"error")});socket.on("previousMessages",messages=>{const messagesContainer=document.getElementById("messages");if(!messagesContainer)return;messagesContainer.innerHTML="";state.displayedUsernames.clear();const loadingIndicator=document.getElementById("loading-indicator");if(loadingIndicator)messagesContainer.appendChild(loadingIndicator);messages.forEach(msg=>{const isCurrentUser=msg.username===state.currentUser;const seenStatus=msg.seenBy&&msg.seenBy.length>=2&&isCurrentUser;const messageElement=createMessageElement(msg.username,msg.message,isCurrentUser,msg.timestamp,msg.imageUrl,msg.messageId,seenStatus);messagesContainer.appendChild(messageElement)});if(messages.length>0){state.lastMessageId=messages[0].messageId}
scrollToBottom();updateActiveUsersDisplay()});socket.on("chatMessage",({user,message,imageUrl,messageId,timestamp,seenBy})=>{const isCurrentUser=user===state.currentUser;const seenStatus=seenBy&&seenBy.length>=2&&isCurrentUser;const messageElement=createMessageElement(user,message,isCurrentUser,timestamp,imageUrl,messageId,seenStatus);const messagesContainer=document.getElementById("messages");if(messagesContainer){const welcomeMsg=messagesContainer.querySelector('.welcome-message');if(welcomeMsg){welcomeMsg.remove()}
messagesContainer.appendChild(messageElement);if(state.autoScrollEnabled){scrollToBottom()}
if(!isCurrentUser&&document.hasFocus()&&state.isJoined){if(state.seenTimeout)clearTimeout(state.seenTimeout);state.seenTimeout=setTimeout(()=>{socket.emit("markAllSeen",{roomId:state.currentRoomId})},CONFIG.seenDebounce)}}
if(state.typingUsers.size>0&&!isCurrentUser&&messagesContainer){scrollToBottom()}});socket.on("updateActiveUsers",(users)=>{state.roomUsers=users;updateActiveUsersDisplay();updateTypingIndicator()});socket.on("messageSeen",({messageIds})=>{if(!messageIds||messageIds.length===0)return;messageIds.forEach(messageId=>{const messageElement=document.querySelector(`.message[data-message-id="${messageId}"]`);if(messageElement&&messageElement.classList.contains('user')&&!messageElement.classList.contains('seen')){const timeElement=messageElement.querySelector('.message-time');if(timeElement){const seenElement=document.createElement('i');seenElement.className='fas fa-check-double seen-status';timeElement.appendChild(seenElement);messageElement.classList.add('seen')}}})});socket.on("typing",(username)=>{if(username!==state.currentUser){state.typingUsers.add(username);updateTypingIndicator();scrollToBottom()}});socket.on("stopTyping",(username)=>{state.typingUsers.delete(username);updateTypingIndicator()});function sendMessage(){const messageInput=document.getElementById("message");let message=messageInput.value.trim();if(!message&&!state.imageFile){showNotification("Please enter a message or select an image.","error");return}
if(!state.isJoined||!state.currentRoomId){showNotification("You must join a room first.","error");return}
if(state.imageFile){handleImageUploadConfirmed(messageInput);return}
const encryptedMessage=encryptMessage(message);if(!encryptedMessage){showNotification("Failed to encrypt message.","error");return}
socket.emit("chatMessage",{roomId:state.currentRoomId,message:encryptedMessage});messageInput.value="";updateCharCount();socket.emit("stopTyping",state.currentRoomId)}
function handleTyping(){if(!state.isJoined)return;const message=document.getElementById("message").value.trim();if(message.length>0){socket.emit("typing",state.currentRoomId)}else{socket.emit("stopTyping",state.currentRoomId)}
if(state.typingTimeout)clearTimeout(state.typingTimeout);state.typingTimeout=setTimeout(()=>{socket.emit("stopTyping",state.currentRoomId)},CONFIG.typingDebounce)}
function updateCharCount(){const messageInput=document.getElementById("message");const charCountSpan=document.getElementById("char-count");const sendButton=document.getElementById("send");if(messageInput&&charCountSpan&&sendButton){const currentLength=messageInput.value.length;charCountSpan.textContent=`${currentLength}/${CONFIG.maxMessageLength}`;const isInputValid=currentLength>0&&currentLength<=CONFIG.maxMessageLength;const isImageSelected=state.imageFile;sendButton.disabled=!(isInputValid||isImageSelected);if(currentLength>CONFIG.maxMessageLength){charCountSpan.style.color='var(--error-color)'}else{charCountSpan.style.color='var(--text-muted)'}}}
function handleImageUpload(event){const file=event.target.files[0];const messageInput=document.getElementById("message");const sendButton=document.getElementById("send");state.imageFile=null;messageInput.placeholder="Type a message...";messageInput.disabled=!1;if(file){if(!file.type.match('image.*')){showNotification("Only image files are allowed.","error");event.target.value='';return}
if(file.size>CONFIG.maxFileSize){showNotification(`File size exceeds limit (${CONFIG.maxFileSize / 1024 / 1024}MB).`,"error");event.target.value='';return}
state.imageFile=file;messageInput.placeholder=`Image selected: ${file.name}. Add caption or send.`;messageInput.disabled=!0;if(sendButton)sendButton.disabled=!1}else{if(sendButton)sendButton.disabled=(messageInput.value.length===0);}}
async function handleImageUploadConfirmed(messageInput){if(!state.imageFile||!state.isJoined){showNotification("No image selected or not in a room.","error");return}
const formData=new FormData();formData.append('image',state.imageFile);formData.append('roomId',state.currentRoomId);formData.append('username',state.currentUser);messageInput.disabled=!0;document.getElementById("send").disabled=!0;document.getElementById("send").innerHTML='<i class="fas fa-spinner fa-spin"></i>';try{const response=await fetch('/upload',{method:'POST',body:formData,});const result=await response.json();if(response.ok){showNotification("Image uploaded successfully.","info")}else{showNotification("Image upload failed: "+(result.error||"Server error."),"error")}}catch(error){console.error('Image upload failed:',error);showNotification("Image upload failed due to network error.","error")}finally{state.imageFile=null;const imageUpload=document.getElementById("imageUpload");if(imageUpload)imageUpload.value='';messageInput.disabled=!1;messageInput.placeholder="Type a message...";document.getElementById("send").innerHTML='<i class="fas fa-paper-plane"></i>';document.getElementById("send").disabled=!0}}
document.addEventListener('DOMContentLoaded',()=>{updateConnectionStatus(socket.connected);const joinButton=document.getElementById("join");if(joinButton){joinButton.addEventListener("click",joinRoom)}
const usernameInput=document.getElementById("username");const roomIdInput=document.getElementById("roomId");if(usernameInput)usernameInput.addEventListener("input",validateInputs);if(roomIdInput)roomIdInput.addEventListener("input",validateInputs);const sendButton=document.getElementById("send");const messageInput=document.getElementById("message");if(sendButton){sendButton.addEventListener("click",sendMessage)}
if(messageInput){messageInput.addEventListener("keydown",(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage()}});messageInput.addEventListener("input",()=>{handleTyping();updateCharCount()})}
const imageUpload=document.getElementById("imageUpload");if(imageUpload){imageUpload.addEventListener("change",handleImageUpload)}
const backButton=document.getElementById("back-button");if(backButton){backButton.addEventListener("click",()=>{if(confirm("Are you sure you want to leave this room?")){socket.emit("leaveRoom");state.isJoined=!1;const loginContainer=document.querySelector('.login-container');const chatContainer=document.getElementById('chat-container');if(loginContainer)loginContainer.style.display='flex';if(chatContainer)chatContainer.style.display='none';const usernameInput=document.getElementById("username");const roomIdInput=document.getElementById("roomId");if(usernameInput)usernameInput.value="";if(roomIdInput)roomIdInput.value="";state.typingUsers.clear();updateTypingIndicator();updateConnectionStatus(socket.connected)}})}
const downloadButton=document.getElementById("download-history-button");if(downloadButton){downloadButton.addEventListener("click",downloadChatHistory)}
const messagesContainer=document.getElementById("messages");if(messagesContainer){messagesContainer.addEventListener("scroll",handleScroll)}
updateCharCount();if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js').then(registration=>{console.log('ServiceWorker registration successful')}).catch(err=>{console.log('ServiceWorker registration failed: ',err)})}});window.addEventListener("focus",()=>{if(state.isJoined&&state.currentRoomId){if(state.seenTimeout)clearTimeout(state.seenTimeout);state.seenTimeout=setTimeout(()=>{socket.emit("markAllSeen",{roomId:state.currentRoomId})},CONFIG.seenDebounce)}})
