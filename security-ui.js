const KeyVerificationUI={TRUST_LEVELS:{UNTRUSTED:0,AUTO_ACCEPTED:1,VERIFIED:2},showVerificationModal(e,i,n=0){this.closeVerificationModal();let a,t=n===this.TRUST_LEVELS.VERIFIED,o=n===this.TRUST_LEVELS.AUTO_ACCEPTED,s=document.createElement("div");s.className="key-verification-modal",s.id="key-verification-modal",a=t?{icon:"check-circle",text:"Manually Verified",class:"verified",color:"#10b981"}:o?{icon:"shield-alt",text:"Auto-Accepted (First Use)",class:"auto-accepted",color:"#3b82f6"}:{icon:"info-circle",text:"Ready to Verify",class:"unverified",color:"#f59e0b"},s.innerHTML=`\n        <div class="verification-overlay"></div>\n        <div class="verification-content">\n        <div class="verification-header">\n        <h3>\n        <i class="fas fa-fingerprint"></i>\n        Encryption Key for ${this.escapeHtml(e)}\n        </h3>\n        <button class="close-btn" onclick="KeyVerificationUI.closeVerificationModal()">\n        <i class="fas fa-times"></i>\n        </button>\n        </div>\n\n        <div class="verification-body">\n        <div class="verification-status ${a.class}">\n        <i class="fas fa-${a.icon}" style="color: ${a.color}"></i>\n        <span>${a.text}</span>\n        </div>\n\n        ${t?'\n            <div class="verification-info success">\n            <i class="fas fa-check-circle"></i>\n            <p>You\'ve manually verified this key is authentic. Your messages are secure.</p>\n            </div>\n            ':o?'\n            <div class="verification-info info">\n            <i class="fas fa-info-circle"></i>\n            <p><strong>Trust on First Use (TOFU):</strong> This key was automatically accepted when you first connected. For maximum security, verify it manually.</p>\n            </div>\n            ':`\n            <div class="verification-info warning">\n            <i class="fas fa-shield-alt"></i>\n            <p><strong>New Key Detected:</strong> Compare this fingerprint with ${this.escapeHtml(e)}</p>\n            </div>\n            `}\n\n            <div class="fingerprint-section">\n            <label>Security Fingerprint:</label>\n            <div class="fingerprint-display">\n            <code>${i}</code>\n            <button class="copy-btn" onclick="KeyVerificationUI.copyFingerprint('${i}')">\n            <i class="fas fa-copy"></i> Copy\n            </button>\n            </div>\n            </div>\n\n            ${t?"":`\n                <div class="verification-explainer">\n                <h4><i class="fas fa-question-circle"></i> Why Verify?</h4>\n                <ul>\n                <li><strong>Prevents impersonation:</strong> Ensures ${this.escapeHtml(e)}'s identity</li>\n                <li><strong>Detects attacks:</strong> Alerts privacy threats</li>\n                <li><strong>One-time process:</strong> Verify once, secure forever</li>\n                </ul>\n                </div>\n\n                <div class="verification-methods">\n                <h4><i class="fas fa-exchange-alt"></i> How to Verify:</h4>\n                <div class="method-list">\n                <div class="method-item">\n                <i class="fas fa-user-friends"></i>\n                <div>\n                <strong>In Person</strong>\n                <p>Show fingerprints on your devices</p>\n                </div>\n                </div>\n                <div class="method-item">\n                <i class="fas fa-qrcode"></i>\n                <div>\n                <strong>QR Code Scan</strong>\n                <p>Scan to automatically verify</p>\n                </div>\n                <button class="method-action-btn" onclick="KeyVerificationUI.showQRScanner('${e}', '${i}')">\n                <i class="fas fa-camera"></i>\n                </button>\n                </div>\n                </div>\n                </div>\n                `}\n                </div>\n\n                <div class="verification-footer">\n                ${t?`\n                    <button class="btn-unverify" onclick="KeyVerificationUI.unverifyKey('${e}')">\n                    <i class="fas fa-times"></i> Remove Verification\n                    </button>\n                    `:`\n                    ${o?"":`\n                        <button class="btn-auto-accept" onclick="KeyVerificationUI.autoAcceptKey('${e}')">\n                        <i class="fas fa-check"></i> Trust This KEY\n                        </button>\n                        `}\n                        <button class="btn-verify" onclick="KeyVerificationUI.confirmVerification('${e}')">\n                        <i class="fas fa-shield-check"></i> Mark as Secure\n                        </button>\n                        `}\n                        <button class="btn-secondary" onclick="KeyVerificationUI.closeVerificationModal()">\n                        Close\n                        </button>\n                        </div>\n                        </div>\n                        `,document.body.appendChild(s),s.querySelector(".verification-overlay").onclick=()=>{this.closeVerificationModal()}},autoAcceptKey(e){window.E2EE&&window.E2EE.markPeerAutoAccepted(e);const i=window.StateManager?.currentRoomId;i&&window.E2EE?(window.E2EE.markUserAsSecure(e,i),window.UIManager&&window.UIManager.showNotification(`‚úì Auto-accepted ${e}'s key - They can decrypt all messages in this room`,"info")):window.UIManager&&window.UIManager.showNotification(`‚úì Auto-accepted ${e}'s key. Consider manual verification for higher security.`,"info"),this.closeVerificationModal(),window.App&&window.App.updateActiveUsers&&window.App.updateActiveUsers()},async showOwnFingerprint(){if(!window.E2EE||!window.E2EE.keyPair)return void(window.UIManager&&window.UIManager.showNotification("No encryption keys available","error"));let e=await window.E2EE.getPublicKeyFingerprint(),i=await window.E2EE.getShortFingerprint();if(!e)return void(window.UIManager&&window.UIManager.showNotification("Failed to generate fingerprint","error"));let n=window.E2EE.keyGenerationDate?Math.floor((Date.now()-window.E2EE.keyGenerationDate)/864e5):0,a=window.E2EE.needsKeyRotation(),t=document.createElement("div");t.className="key-verification-modal",t.id="key-verification-modal",t.innerHTML=`\n        <div class="verification-overlay"></div>\n        <div class="verification-content">\n        <div class="verification-header">\n        <h3>\n        <i class="fas fa-fingerprint"></i>\n        Your Encryption Key\n        </h3>\n        <button class="close-btn" onclick="KeyVerificationUI.closeVerificationModal()">\n        <i class="fas fa-times"></i>\n        </button>\n        </div>\n\n        <div class="verification-body">\n        <div class="key-status-banner ${a?"warning":"success"}">\n        <i class="fas fa-${a?"exclamation-triangle":"check-circle"}"></i>\n        <div>\n        <strong>${a?"Key Rotation Recommended":"Key Active"}</strong>\n        <p>Key age: ${n} days ${a?"(>30 days old)":""}</p>\n        </div>\n        ${a?'\n            <button class="btn-small" onclick="KeyVerificationUI.rotateKeys()">\n            <i class="fas fa-sync"></i> Rotate Now\n            </button>\n            ':""}\n            </div>\n\n            <div class="verification-info">\n            <p>Share this fingerprint with others to verify your identity:</p>\n            </div>\n\n            <div class="fingerprint-section">\n            <label>Full Fingerprint:</label>\n            <div class="fingerprint-display">\n            <code>${e}</code>\n            <button class="copy-btn" onclick="KeyVerificationUI.copyFingerprint('${e}')">\n            <i class="fas fa-copy"></i> Copy\n            </button>\n            </div>\n            </div>\n\n            <div class="fingerprint-section">\n            <label>Short Version (Quick Compare):</label>\n            <div class="fingerprint-display short">\n            <code>${i}</code>\n            <button class="copy-btn" onclick="KeyVerificationUI.copyFingerprint('${i}')">\n            <i class="fas fa-copy"></i> Copy\n            </button>\n            </div>\n            </div>\n\n            <div class="key-security-info">\n            <i class="fas fa-lock"></i>\n            <div>\n            <strong>Security:</strong> Your private key is stored securely in IndexedDB\n            </div>\n            </div>\n\n            <div class="key-actions-grid">\n            <button class="action-card" onclick="KeyVerificationUI.showQRCode()">\n            <i class="fas fa-qrcode"></i>\n            <span>Show QR Code</span>\n            </button>\n            <button class="action-card" onclick="KeyVerificationUI.exportBackup()">\n            <i class="fas fa-download"></i>\n            <span>Backup Messages</span>\n            </button>\n            <button class="action-card" onclick="KeyVerificationUI.showDebugInfo()">\n            <i class="fas fa-info-circle"></i>\n            <span>Security Info</span>\n            </button>\n            </div>\n            </div>\n\n            <div class="verification-footer">\n            <button class="btn-secondary" onclick="KeyVerificationUI.closeVerificationModal()">\n            Close\n            </button>\n            </div>\n            </div>\n            `,document.body.appendChild(t),t.querySelector(".verification-overlay").onclick=()=>{this.closeVerificationModal()}},async showUserList(e,i){let n=document.createElement("div");n.className="key-verification-modal",n.id="key-verification-modal";let a="",t=0,o=0,s=0;for(let n of e){if(n.username===i)continue;let e,r,c,l=window.E2EE.peerFingerprints.get(n.username),d=this.getTrustLevel(n.username),f=l?l.split(" ").slice(0,6).join(" "):"Loading...";d===this.TRUST_LEVELS.VERIFIED?(e="Verified",r="verified",c="check-circle",t++):d===this.TRUST_LEVELS.AUTO_ACCEPTED?(e="Auto-Accepted",r="auto-accepted",c="shield-alt",o++):(e="Not Verified",r="unverified",c="info-circle",s++),a+=`\n            <div class="user-list-item ${r}">\n            <div class="user-info">\n            <div class="user-name">\n            <i class="fas fa-user"></i>\n            <strong>${this.escapeHtml(n.username)}</strong>\n            </div>\n            <div class="user-fingerprint">\n            <code>${f}</code>\n            </div>\n            </div>\n            <div class="user-actions">\n            <span class="verification-badge ${r}">\n            <i class="fas fa-${c}"></i>\n            ${e}\n            </span>\n            ${l?`\n                <button class="btn-small" onclick="KeyVerificationUI.verifyUser('${n.username}', '${l}', ${d})">\n                <i class="fas fa-fingerprint"></i> View\n                </button>\n                `:'\n                <button class="btn-small disabled" disabled>\n                <i class="fas fa-spinner fa-spin"></i> Loading\n                </button>\n                '}\n                </div>\n                </div>\n                `}let r=e.length-1,c=r>0?Math.round(t/r*100):100;n.innerHTML=`\n        <div class="verification-overlay"></div>\n        <div class="verification-content user-list-modal">\n        <div class="verification-header">\n        <h3>\n        <i class="fas fa-users"></i>\n        Room Security & Users\n        </h3>\n        <button class="close-btn" onclick="KeyVerificationUI.closeVerificationModal()">\n        <i class="fas fa-times"></i>\n        </button>\n        </div>\n\n        ${r>0?`\n            <div class="security-score-banner">\n            <div class="score-circle ${100===c?"perfect":c>=50?"good":"warning"}">\n            <span class="score-number">${c}%</span>\n            <span class="score-label">Verified</span>\n            </div>\n            <div class="score-details">\n            <div class="score-item">\n            <i class="fas fa-check-circle" style="color: #10b981"></i>\n            <span>${t} Verified</span>\n            </div>\n            <div class="score-item">\n            <i class="fas fa-shield-alt" style="color: #3b82f6"></i>\n            <span>${o} Auto-Accepted</span>\n            </div>\n            <div class="score-item">\n            <i class="fas fa-info-circle" style="color: #f59e0b"></i>\n            <span>${s} Unverified</span>\n            </div>\n            </div>\n            </div>\n            `:""}\n\n            <div class="verification-body">\n            ${a||'<div class="empty-state"><i class="fas fa-users"></i><p>No other users in this room</p></div>'}\n            </div>\n\n            <div class="verification-footer">\n            <button class="btn-primary" onclick="KeyVerificationUI.showOwnFingerprint()">\n            <i class="fas fa-fingerprint"></i> Own KEY\n            </button>\n            ${s>0?'\n                <button class="btn-auto-accept-all" onclick="KeyVerificationUI.autoAcceptAll()">\n                <i class="fas fa-check-double"></i> Auto-Accept All\n                </button>\n                ':""}\n                <button class="btn-secondary" onclick="KeyVerificationUI.closeVerificationModal()">\n                Close\n                </button>\n                </div>\n                </div>\n                `,document.body.appendChild(n),n.querySelector(".verification-overlay").onclick=()=>{this.closeVerificationModal()}},getTrustLevel(e){return window.E2EE?window.E2EE.isPeerVerified(e)?this.TRUST_LEVELS.VERIFIED:window.E2EE.isPeerAutoAccepted&&window.E2EE.isPeerAutoAccepted(e)?this.TRUST_LEVELS.AUTO_ACCEPTED:this.TRUST_LEVELS.UNTRUSTED:this.TRUST_LEVELS.UNTRUSTED},autoAcceptAll(){if(confirm('Mark entire room as "Secure for All"?\n\n‚úì All users (current and future) can decrypt all messages\n‚úì New users joining will receive all message history\n‚úì Users who leave and return will still have access\n\n‚ö†Ô∏è This is less secure than verifying individual keys.\n\nContinue?')){const e=window.StateManager?.currentRoomId;if(window.E2EE&&window.StateManager){let i=0;for(let e of window.StateManager.roomUsers||[])e.username!==window.StateManager.currentUser&&this.getTrustLevel(e.username)===this.TRUST_LEVELS.UNTRUSTED&&(window.E2EE.markPeerAutoAccepted(e.username),i++);e?(window.E2EE.markRoomAsSecure(e),window.UIManager&&window.UIManager.showNotification('‚úì Room marked as "Secure for All" - All users can access all messages',"success")):window.UIManager&&window.UIManager.showNotification(`‚úì Auto-accepted ${i} keys`,"info")}this.closeVerificationModal()}},verifyUser(e,i,n){this.showVerificationModal(e,i,n)},confirmVerification(e){window.E2EE&&window.E2EE.markPeerVerified(e);const i=window.StateManager?.currentRoomId;i&&window.E2EE?(window.E2EE.markUserAsSecure(e,i),window.UIManager&&window.UIManager.showNotification(`‚úì ${e}'s key verified - They can now decrypt all messages in this room`,"success")):window.UIManager&&window.UIManager.showNotification(`‚úì ${e}'s key manually verified`,"success"),this.closeVerificationModal(),window.App&&window.App.updateActiveUsers&&window.App.updateActiveUsers()},unverifyKey(e){confirm(`Remove verification for ${e}? This will not affect message delivery.`)&&(window.E2EE&&(window.E2EE.verifiedPeers.delete(e),window.E2EE.autoAcceptedPeers&&window.E2EE.autoAcceptedPeers.delete(e),window.E2EE.saveVerifiedPeers()),window.UIManager&&window.UIManager.showNotification(`${e}'s key verification removed`,"info"),this.closeVerificationModal())},async showQRCode(){if(!window.E2EE||!window.E2EE.keyPair)return void(window.UIManager&&window.UIManager.showNotification("No encryption keys available","error"));let e=await window.E2EE.getPublicKeyFingerprint(),i=await window.E2EE.exportPublicKey();if(!e||!i)return void(window.UIManager&&window.UIManager.showNotification("Failed to generate QR code","error"));let n=JSON.stringify({type:"e2ee-key",version:"3.0",username:window.StateManager?window.StateManager.currentUser:"User",fingerprint:e,publicKey:i,timestamp:Date.now()}),a=document.createElement("div");a.className="key-verification-modal",a.id="key-verification-modal",a.innerHTML=`\n        <div class="verification-overlay"></div>\n        <div class="verification-content">\n        <div class="verification-header">\n        <h3>\n        <i class="fas fa-qrcode"></i>\n        Your QR Code\n        </h3>\n        <button class="close-btn" onclick="KeyVerificationUI.closeVerificationModal()">\n        <i class="fas fa-times"></i>\n        </button>\n        </div>\n\n        <div class="verification-body">\n        <div class="verification-info info">\n        <i class="fas fa-info-circle"></i>\n        <p>Have the other person scan this QR code to automatically verify your key.</p>\n        </div>\n\n        <div class="qr-code-container">\n        <div id="qr-code-display"></div>\n        </div>\n\n        <div class="fingerprint-section">\n        <label>Fingerprint (for manual comparison):</label>\n        <div class="fingerprint-display short">\n        <code>${e.split(" ").slice(0,6).join(" ")}</code>\n        </div>\n        </div>\n        </div>\n\n        <div class="verification-footer">\n        <button class="btn-primary" onclick="KeyVerificationUI.showQRScanner()">\n        <i class="fas fa-camera"></i> Scan Someone's QR\n        </button>\n        <button class="btn-secondary" onclick="KeyVerificationUI.closeVerificationModal()">\n        Close\n        </button>\n        </div>\n        </div>\n        `,document.body.appendChild(a),this.generateQRCode("qr-code-display",n),a.querySelector(".verification-overlay").onclick=()=>{this.closeVerificationModal()}},generateQRCode(e,i){let n=document.getElementById(e);if(n)if("undefined"!=typeof QRCode)new QRCode(n,{text:i,width:280,height:280,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});else{let e=document.createElement("script");e.src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js",e.onload=()=>{new QRCode(n,{text:i,width:280,height:280,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})},e.onerror=()=>{n.innerHTML='<p style="text-align: center; opacity: 0.7;">QR Code generation failed. Please verify manually.</p>'},document.head.appendChild(e)}},async showQRScanner(e=null,i=null){let n=document.createElement("div");n.className="key-verification-modal",n.id="key-verification-modal",n.innerHTML='\n        <div class="verification-overlay"></div>\n        <div class="verification-content">\n        <div class="verification-header">\n        <h3>\n        <i class="fas fa-camera"></i>\n        Scan QR Code\n        </h3>\n        <button class="close-btn" onclick="KeyVerificationUI.closeVerificationModal()">\n        <i class="fas fa-times"></i>\n        </button>\n        </div>\n\n        <div class="verification-body">\n        <div class="verification-info info">\n        <i class="fas fa-info-circle"></i>\n        <p>Position the QR code within the camera frame to automatically verify the encryption key.</p>\n        </div>\n\n        <div class="qr-scanner-container">\n        <video id="qr-video" autoplay playsinline></video>\n        <canvas id="qr-canvas" style="display: none;"></canvas>\n        <div class="scanner-overlay">\n        <div class="scanner-frame"></div>\n        </div>\n        </div>\n\n        <div id="scan-result" class="scan-result" style="display: none;"></div>\n        </div>\n\n        <div class="verification-footer">\n        <button class="btn-secondary" onclick="KeyVerificationUI.closeVerificationModal()">\n        Cancel\n        </button>\n        </div>\n        </div>\n        ',document.body.appendChild(n),n.querySelector(".verification-overlay").onclick=()=>{this.stopQRScanner(),this.closeVerificationModal()},this.startQRScanner(e,i)},async startQRScanner(e,i){let n=document.getElementById("qr-video"),a=document.getElementById("qr-canvas");if(n&&a)try{"undefined"==typeof jsQR&&await this.loadJsQR();let t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:60,min:30}}});n.srcObject=t,this.qrScannerStream=t,this.qrScannerActive=!0;let o=a.getContext("2d",{willReadFrequently:!0,alpha:!1,desynchronized:!0});await new Promise((e=>{n.onloadedmetadata=()=>{n.play(),e()}}));let s=0,r=0,c=performance.now(),l=()=>{if(document.getElementById("qr-video")&&this.qrScannerActive){if(n.readyState===n.HAVE_ENOUGH_DATA&&n.videoWidth>0&&n.videoHeight>0){let t=n.videoWidth,l=n.videoHeight,d=Math.floor(t/2),f=Math.floor(l/2);a.width=d,a.height=f,o.drawImage(n,0,0,d,f);let v=o.getImageData(0,0,d,f);try{let n=jsQR(v.data,v.width,v.height,{inversionAttempts:"dontInvert"});if(n&&n.data){this.qrScannerActive=!1;let a=performance.now()-c;return console.log(`QR Code detected in ${a.toFixed(0)}ms (${s} frames, ${(1e3*s/a).toFixed(1)} fps)`),void this.handleQRScanResult(n.data,e,i)}}catch(e){console.error("QR decode error:",e)}s++,r++,performance.now()-c>1e3&&(console.log(`QR Scanner FPS: ${r}`),r=0,c=performance.now())}this.qrScannerActive&&requestAnimationFrame(l)}};requestAnimationFrame(l)}catch(e){console.error("QR Scanner error:",e);let i=document.getElementById("scan-result");if(i){i.style.display="block";let n="Camera access denied or not available. Please verify keys manually.";"NotAllowedError"===e.name?n="Camera access denied. Please allow camera permissions and try again.":"NotFoundError"===e.name?n="No camera found on this device. Please verify keys manually.":"NotReadableError"===e.name&&(n="Camera is already in use by another application."),i.innerHTML=`\n                <div class="verification-info warning">\n                <i class="fas fa-exclamation-triangle"></i>\n                <p>${n}</p>\n                </div>\n                `}}},loadJsQR:async()=>new Promise(((e,i)=>{let n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js",n.onload=e,n.onerror=i,document.head.appendChild(n)})),async handleQRScanResult(e,i,n){this.stopQRScanner();try{let a=JSON.parse(e);if("e2ee-key"!==a.type||!a.username||!a.fingerprint||!a.publicKey)throw Error("Invalid QR code format");let t=document.getElementById("scan-result");if(i&&a.username!==i)return void(t&&(t.style.display="block",t.innerHTML=`\n                <div class="verification-info warning">\n                <i class="fas fa-exclamation-triangle"></i>\n                <p><strong>Warning:</strong> This QR code is for "${this.escapeHtml(a.username)}", but you expected "${this.escapeHtml(i)}".</p>\n                </div>\n                `));if(n&&a.fingerprint!==n)return t&&(t.style.display="block",t.innerHTML='\n                <div class="verification-info warning">\n                <i class="fas fa-times-circle"></i>\n                <p><strong>Verification Failed:</strong> Fingerprint mismatch! This could indicate a security issue.</p>\n                </div>\n                '),void(window.UIManager&&window.UIManager.showNotification("‚ö†Ô∏è Fingerprint mismatch detected!","error"));window.E2EE&&await window.E2EE.importPublicKey(a.username,a.publicKey)&&await window.E2EE.verifyPeerFingerprint(a.username,a.fingerprint)&&(t&&(t.style.display="block",t.innerHTML=`\n            <div class="verification-info success">\n            <i class="fas fa-check-circle"></i>\n            <p><strong>Success!</strong> ${this.escapeHtml(a.username)}'s key verified automatically via QR code.</p>\n            </div>\n            `),window.UIManager&&window.UIManager.showNotification(`‚úì ${a.username}'s key verified via QR scan`,"success"),setTimeout((()=>{this.closeVerificationModal()}),2e3))}catch(e){console.error("QR scan handling error:",e);let i=document.getElementById("scan-result");i&&(i.style.display="block",i.innerHTML='\n            <div class="verification-info warning">\n            <i class="fas fa-exclamation-triangle"></i>\n            <p>Invalid QR code. Please try again or verify manually.</p>\n            </div>\n            ')}},stopQRScanner(){this.qrScannerTimeout&&(clearTimeout(this.qrScannerTimeout),this.qrScannerTimeout=null),this.qrScannerStream&&(this.qrScannerStream.getTracks().forEach((e=>e.stop())),this.qrScannerStream=null)},async rotateKeys(){confirm("Rotate encryption keys? This will re-encrypt all stored messages.")&&(this.closeVerificationModal(),window.UIManager&&window.UIManager.showNotification("Rotating keys...","info"),window.E2EE)&&await window.E2EE.rotateKeysWithMessages()&&window.UIManager&&window.UIManager.showNotification("‚úì Keys rotated successfully","success")},async exportBackup(){let e=prompt("Enter a strong password to encrypt your backup:");if(e){if(e.length<8)return void alert("Password must be at least 8 characters");if(window.UIManager&&window.UIManager.showNotification("Creating encrypted backup...","info"),window.E2EE){let i=await window.E2EE.exportMessagesBackup(e);if(i){let e=new Blob([JSON.stringify(i,null,2)],{type:"application/json"}),n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=`e2ee-backup-${Date.now()}.json`,a.click(),URL.revokeObjectURL(n),window.UIManager&&window.UIManager.showNotification("‚úì Backup downloaded successfully","success")}}}},showDebugInfo(){if(!window.E2EE)return;let e=window.E2EE.getDebugInfo();alert(`E2EE Debug Information:\n\n        Has KeyPair: ${e.hasKeyPair}\n        Key Age: ${e.keyAge?Math.floor(e.keyAge/864e5)+" days":"N/A"}\n        Keys Expired: ${e.keysExpired}\n        Needs Rotation: ${e.needsRotation}\n        Peer Count: ${e.peerCount}\n        Verified Peers: ${e.verifiedPeerCount}\n        Failed Decryptions: ${e.failedDecryptions}\n        Session Keys: ${e.sessionKeys}\n        Rotation Scheduler: ${e.rotationSchedulerActive?"Active":"Inactive"}\n        Secure Storage: ${e.secureStorage}`)},copyFingerprint(e){navigator.clipboard.writeText(e).then((()=>{window.UIManager&&window.UIManager.showNotification("üìã Fingerprint copied","info")})).catch((e=>{console.error("Failed to copy:",e)}))},closeVerificationModal(){this.stopQRScanner();let e=document.getElementById("key-verification-modal");e&&e.remove()},showDecryptionError(e,i){let n=document.querySelector(`[data-message-id="${e}"]`);if(!n)return;let a=document.createElement("div");a.className="decryption-error-badge",a.innerHTML=`\n        <i class="fas fa-exclamation-triangle"></i>\n        <span>Decryption failed</span>\n        <button class="retry-btn" onclick="KeyVerificationUI.retryDecryption('${e}')">\n        <i class="fas fa-redo"></i> Retry\n        </button>\n        `;let t=n.querySelector(".message-content");if(t){let e=t.querySelector(".decryption-error-badge");e&&e.remove(),t.appendChild(a)}},async retryDecryption(e){window.App&&window.App.retryMessageDecryption&&await window.App.retryMessageDecryption(e)},addVerificationButton(){let e=document.querySelector(".chat-header .header-content");if(!e||document.getElementById("verify-keys-btn"))return;let i=document.createElement("button");i.id="verify-keys-btn",i.className="icon-button",i.setAttribute("aria-label","View encryption status"),i.innerHTML='<i class="fas fa-shield-alt"></i>',i.onclick=()=>{window.StateManager&&window.StateManager.roomUsers&&this.showUserList(window.StateManager.roomUsers,window.StateManager.currentUser)};let n=document.getElementById("download-history-button");n?n.parentNode.insertBefore(i,n):e.appendChild(i)},escapeHtml(e){let i=document.createElement("div");return i.textContent=e,i.innerHTML},init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{setTimeout((()=>this.addVerificationButton()),1e3)})):setTimeout((()=>this.addVerificationButton()),1e3),window.E2EE&&window.E2EE.loadVerifiedPeers()}};"undefined"!=typeof window&&(window.KeyVerificationUI=KeyVerificationUI,KeyVerificationUI.init()),"undefined"!=typeof module&&(module.exports=KeyVerificationUI);
