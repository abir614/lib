const socket=io();let autoScrollEnabled=!0,isLoadingMoreMessages=!1,SECRET_KEY="xSAjwEE70Ilu4EN6iM1yTB-9A6ut4OfWDVmlZi82Q_w=";function setSecretKey(e){SECRET_KEY=e}function encryptMessage(e){let t=CryptoJS.lib.WordArray.random(16),l=CryptoJS.AES.encrypt(e,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:t});return t.toString()+":"+l.toString()}function decryptMessage(e){let t=e.split(":");if(2!==t.length)return console.error("Invalid ciphertext format"),null;let l=CryptoJS.enc.Hex.parse(t[0]),s=t[1],n=CryptoJS.AES.decrypt(s,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:l}),a=n.toString(CryptoJS.enc.Utf8);return a||console.warn("Decryption failed for message:",e),a}function validateInputs(){let e=document.getElementById("username").value,t=document.getElementById("roomId").value,l=/^[a-zA-Z0-9]{4,20}$/.test(e);document.getElementById("username").style.backgroundColor=l?"lightgreen":"lightcoral";let s=/^\d{1,5}$/.test(t);return document.getElementById("roomId").style.backgroundColor=s?"lightgreen":"lightcoral",l&&s}function scrollToBottom(){let e=document.getElementById("messages");e.scrollTop=e.scrollHeight}function createMessageElement(e,t,l,s,n){let a=document.createElement("div");if(a.className=l?"message user":"message receiver",n){let o=document.createElement("img");o.src=n,o.alt="User uploaded image",o.style.maxWidth="200px",a.appendChild(o)}else{let r=decryptMessage(t);a.innerText=r,r||(console.warn("Decryption failed for message:",t),a.innerText="[Message could not be decrypted]")}return a.dataset.timestamp=s,a}document.getElementById("join").addEventListener("click",()=>{if(validateInputs()){let e=document.getElementById("username").value,t=document.getElementById("roomId").value;socket.emit("joinRoom",{username:e,roomId:t}),document.getElementById("login-form").style.display="none",document.getElementById("chat-container").style.display="flex"}else alert("Login failed: Please enter valid username and room ID.")}),socket.on("previousMessages",e=>{console.log("Received previous messages:",e),e.forEach(({username:e,message:t,timestamp:l,imageUrl:s})=>{let n=document.getElementById("username").value,a=createMessageElement(e,t,e===n,l,s);document.getElementById("messages").appendChild(a)}),scrollToBottom()}),socket.on("olderMessages",e=>{let t=document.getElementById("messages"),l=t.scrollHeight;e.forEach(({username:e,message:l,timestamp:s,imageUrl:n})=>{let a=document.getElementById("username").value,o=createMessageElement(e,l,e===a,s,n);t.insertBefore(o,t.firstChild)}),t.scrollTop=t.scrollHeight-l,isLoadingMoreMessages=!1}),socket.on("chatMessage",({user:e,message:t,imageUrl:l})=>{let s=document.getElementById("username").value;if(l){let n=createMessageElement(e,null,e===s,null,l);document.getElementById("messages").appendChild(n)}else{let a=createMessageElement(e,t,e===s,null);document.getElementById("messages").appendChild(a)}autoScrollEnabled&&scrollToBottom()}),document.getElementById("imageUpload").addEventListener("change",function(){let e=document.getElementById("imageUploadLabel"),t=this.files[0];if(t){e.textContent=`ðŸ“· ${t.name}`;let l=new FileReader;l.onload=function(l){let s=l.target.result,n=document.getElementById("roomId").value;socket.emit("imageUpload",{roomId:n,file:{name:t.name,data:s}}),document.getElementById("imageUpload").value="",e.textContent="\uD83D\uDCF7"},l.readAsArrayBuffer(t)}else e.textContent="\uD83D\uDCF7"}),socket.on("imageUpload",({user:e,imageUrl:t})=>{let l=document.getElementById("username").value,s=createMessageElement(e,null,e===l,null,t);document.getElementById("messages").appendChild(s),autoScrollEnabled&&scrollToBottom()});let typingTimeout;function sendMessage(){let e=document.getElementById("message"),t=e.value,l=document.getElementById("roomId").value;if(t){let s=encryptMessage(t);socket.emit("chatMessage",{roomId:l,message:s}),e.value="",socket.emit("stopTyping",l)}}document.getElementById("message").addEventListener("input",()=>{let e=document.getElementById("roomId").value;e&&(socket.emit("typing",e),clearTimeout(typingTimeout),typingTimeout=setTimeout(()=>{socket.emit("stopTyping",e)},1e3))}),document.getElementById("send").addEventListener("click",sendMessage),document.getElementById("message").addEventListener("keydown",e=>{"Enter"===e.key&&(sendMessage(),e.preventDefault())}),socket.on("typing",e=>{let t=document.getElementById("messages"),l=t.querySelector(".typing-indicator"),s=document.getElementById("username").value;if(e!==s&&!l){let n=document.createElement("div");n.className="typing-indicator",n.innerText=`${e} is typing...`,t.appendChild(n)}}),socket.on("stopTyping",()=>{let e=document.querySelector(".typing-indicator");e&&e.remove()}),socket.on("updateActiveUsers",e=>{let t=document.getElementById("username").value,l=e.filter(e=>e.username!==t);document.getElementById("active-users").innerHTML="Active Users: "+l.map(e=>e.username).join(", ")}),document.getElementById("messages").addEventListener("scroll",()=>{let e=document.getElementById("messages");if(0===e.scrollTop&&!isLoadingMoreMessages){isLoadingMoreMessages=!0;let t=document.getElementById("roomId").value,l=e.firstChild?.dataset?.timestamp;t&&l&&socket.emit("loadMoreMessages",{roomId:t,oldestMessageTimestamp:l})}let s=e.scrollHeight-e.scrollTop<=e.clientHeight+5;autoScrollEnabled=s}),scrollToBottom();
