const IntegrityChecker={checkEnvironment(){const checks={hasWindow:typeof window!=='undefined',hasDocument:typeof document!=='undefined',hasNavigator:typeof navigator!=='undefined',hasUserAgent:!!navigator.userAgent,hasPlugins:navigator.plugins!==undefined,hasLanguages:navigator.languages!==undefined,hasPlatform:!!navigator.platform,hasScreen:typeof screen!=='undefined',hasHistory:typeof history!=='undefined',hasLocalStorage:typeof localStorage!=='undefined'};const passedChecks=Object.values(checks).filter(v=>v).length;return passedChecks>=8},checkHeadless(){try{const headlessIndicators=[!navigator.webdriver,!window.callPhantom,!window._phantom,!window.__nightmare,navigator.plugins.length>0,'ontouchstart' in window||navigator.maxTouchPoints>0||window.matchMedia('(pointer:coarse)').matches,!/HeadlessChrome/.test(navigator.userAgent),!/PhantomJS/.test(navigator.userAgent)];const passed=headlessIndicators.filter(v=>v).length;return passed>=6}catch(e){return!1}},checkBrowserFeatures(){try{const features={hasCanvas:!!document.createElement('canvas').getContext,hasWebGL:this.checkWebGL(),hasAudio:typeof Audio!=='undefined',hasNotification:'Notification' in window,hasIndexedDB:'indexedDB' in window,hasServiceWorker:'serviceWorker' in navigator,hasGeolocation:'geolocation' in navigator,hasConnection:'connection' in navigator||'mozConnection' in navigator||'webkitConnection' in navigator};const passed=Object.values(features).filter(v=>v).length;return passed>=5}catch(e){return!1}},checkWebGL(){try{const canvas=document.createElement('canvas');return!!(canvas.getContext('webgl')||canvas.getContext('experimental-webgl'))}catch(e){return!1}},hasUserInteraction(){return window.hasUserInteracted===!0},getCanvasFingerprint(){try{const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');const text='BrowserCheck<Canvas>';ctx.textBaseline='top';ctx.font='14px Arial';ctx.fillStyle='#f60';ctx.fillRect(125,1,62,20);ctx.fillStyle='#069';ctx.fillText(text,2,15);ctx.fillStyle='rgba(102,126,234,0.7)';ctx.fillText(text,4,17);const dataURL=canvas.toDataURL();return dataURL.length>100}catch(e){return!1}},async checkTimingConsistency(){try{const timings=[];for(let i=0;i<5;i++){const start=performance.now();await new Promise(resolve=>setTimeout(resolve,10));const end=performance.now();timings.push(end-start)}const avg=timings.reduce((a,b)=>a+b)/timings.length;const variance=timings.reduce((sum,val)=>sum+Math.pow(val-avg,2),0)/timings.length;return avg>=8&&avg<=20&&variance>0.1&&variance<50}catch(e){return!1}},checkScreenProperties(){try{const hasRealisticScreen=screen.width>=320&&screen.width<=7680&&screen.height>=240&&screen.height<=4320&&window.innerWidth>0&&window.innerHeight>0&&screen.availWidth>0&&screen.availHeight>0;return hasRealisticScreen}catch(e){return!1}},generateChallengeToken(){const timestamp=Date.now();const random=Math.random().toString(36).substring(2,15);const userAgent=navigator.userAgent.substring(0,20);const screenStr=`${window.innerWidth}x${window.innerHeight}`;const data=`${timestamp}-${random}-${userAgent}-${screenStr}`;let hash=0;for(let i=0;i<data.length;i++){const char=data.charCodeAt(i);hash=((hash<<5)-hash)+char;hash=hash&hash}return Math.abs(hash).toString(36)},async performIntegrityCheck(){const results={environment:this.checkEnvironment(),headless:this.checkHeadless(),features:this.checkBrowserFeatures(),userInteraction:this.hasUserInteraction(),canvas:this.getCanvasFingerprint(),timing:await this.checkTimingConsistency(),screen:this.checkScreenProperties()};const score=Object.values(results).filter(v=>v===!0).length;const passed=score>=5;return{passed,score,maxScore:7,results,token:passed?this.generateChallengeToken():null,timestamp:Date.now()}},initUserInteractionTracking(){window.hasUserInteracted=!1;const events=['mousedown','mousemove','keydown','touchstart','click'];events.forEach(event=>{document.addEventListener(event,()=>{window.hasUserInteracted=!0},{once:!0,passive:!0})})}};if(typeof module!=="undefined"){module.exports=IntegrityChecker}if(typeof window!=="undefined"){window.IntegrityChecker=IntegrityChecker}
