const IntegrityChecker={checkEnvironment(){try{let e={hasWindow:"undefined"!=typeof window,hasDocument:"undefined"!=typeof document,hasNavigator:"undefined"!=typeof navigator,hasUserAgent:!!(navigator&&navigator.userAgent),hasPlugins:navigator&&void 0!==navigator.plugins,hasLanguages:!!(navigator&&navigator.languages&&navigator.languages.length>=0),hasPlatform:!!(navigator&&navigator.platform),hasScreen:"undefined"!=typeof screen,hasHistory:"undefined"!=typeof history,hasLocalStorage:(()=>{try{return"undefined"!=typeof localStorage}catch(e){return!1}})(),hasHardwareConcurrency:!!(navigator&&navigator.hardwareConcurrency)};return Object.values(e).filter(Boolean).length>=8}catch(t){return!1}},checkHeadless(){try{let e=navigator&&navigator.userAgent||"",t=[!navigator.webdriver,!!(navigator.plugins&&navigator.plugins.length>0),!!window.chrome,!/HeadlessChrome|Phantom|SlimerJS|puppeteer/i.test(e),!("__nightmare"in window),!("callPhantom"in window),(navigator.maxTouchPoints||0)>=0,!!(navigator.languages&&navigator.languages.length),!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),];return t.filter(Boolean).length>=6}catch(n){return!1}},checkBrowserFeatures(){try{let e={hasCanvas:(()=>{try{return!!document.createElement("canvas").getContext}catch(e){return!1}})(),hasWebGL:"function"==typeof this.checkWebGL&&this.checkWebGL(),hasAudio:"undefined"!=typeof Audio,hasNotification:"undefined"!=typeof window&&"Notification"in window,hasIndexedDB:"undefined"!=typeof indexedDB,hasServiceWorker:"undefined"!=typeof navigator&&"serviceWorker"in navigator,hasGeolocation:"undefined"!=typeof navigator&&"geolocation"in navigator,hasConnection:"undefined"!=typeof navigator&&("connection"in navigator||"mozConnection"in navigator||"webkitConnection"in navigator),hasPermissions:"undefined"!=typeof navigator&&"permissions"in navigator},t=Object.values(e).filter(e=>!1!==e&&null!==e).length;return t>=5}catch(n){return!1}},checkWebGL(){try{let e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return!1;let n="",r="";try{let a=t.getExtension("WEBGL_debug_renderer_info");a&&(n=t.getParameter(a.UNMASKED_RENDERER_WEBGL)||"",r=t.getParameter(a.UNMASKED_VENDOR_WEBGL)||"")}catch(i){}if(n&&/swiftshader|llvmpipe|mesa|software/i.test(n))return"software";return"hardware"}catch(o){return!1}},hasUserInteraction:()=>!0===window.hasUserInteracted,getCanvasFingerprint(){try{let e=document.createElement("canvas");e.width=220,e.height=60;let t=e.getContext("2d");if(!t)return!1;let n="IntegrityChecker-FP";t.textBaseline="top",t.font='16px "Arial"',t.fillStyle="#f60",t.fillRect(10,10,100,20),t.fillStyle="#069",t.fillText(n,12,12),t.fillStyle="rgba(102,126,234,0.7)",t.fillText(n,14,14);let r=e.toDataURL();return r&&r.length>120}catch(a){return!1}},async checkTimingConsistency(){try{let e=[];for(let t=0;t<8;t++){let n=performance.now();await new Promise(e=>setTimeout(e,10+t%3)),e.push(performance.now()-n)}let r=e.reduce((e,t)=>e+t,0)/e.length,a=e.map(e=>(e-r)**2).reduce((e,t)=>e+t,0)/e.length;return r>=6&&r<=60&&a>=.02}catch(i){return!1}},checkScreenProperties(){try{if(screen&&(screen.width<300||screen.height<300)||"undefined"==typeof window||window.innerWidth<=0||window.innerHeight<=0)return!1;let e=window.innerWidth/(screen?screen.width:window.innerWidth);if(e<.25||e>1.15)return!1;return!0}catch(t){return!1}},generateChallengeToken(){let e=`${Date.now()}-${Math.random()}-${navigator.userAgent}`,t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return Math.abs(t).toString(36)},async detectProxyVPN(){if("undefined"==typeof RTCPeerConnection)return null;let e=new Set;return new Promise(t=>{try{let n=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});try{n.createDataChannel("icmp")}catch(r){}n.onicecandidate=r=>{if(!r.candidate){try{n.close()}catch(a){}let i=Array.from(e),o=/^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1]))/,s=i.filter(e=>!o.test(e));t({ips:i,publicIps:s});return}let c=r.candidate.candidate||"",l=/\b(?:\d{1,3}\.){3}\d{1,3}\b|([A-Fa-f0-9]{1,4}:){2,}[\w:]*\b/g,h;for(;null!==(h=l.exec(c));){let u=h[0];u&&u.length>6&&e.add(u)}},n.createOffer().then(e=>n.setLocalDescription(e)).catch(()=>{try{n.close()}catch(e){}t(null)}),setTimeout(()=>{try{n.close()}catch(r){}let a=Array.from(e);t(a.length?{ips:a,publicIps:a.filter(e=>!/^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1]))/.test(e))}:null)},2500)}catch(a){t(null)}})},detectTampering(){try{let e=[],t=[];try{Function.prototype.toString&&t.push(Function.prototype.toString)}catch(n){}try{HTMLElement&&HTMLElement.prototype&&HTMLElement.prototype.toString&&t.push(HTMLElement.prototype.toString)}catch(r){}try{CanvasRenderingContext2D&&CanvasRenderingContext2D.prototype&&CanvasRenderingContext2D.prototype.fillText&&t.push(CanvasRenderingContext2D.prototype.fillText)}catch(a){}try{XMLHttpRequest&&XMLHttpRequest.prototype&&XMLHttpRequest.prototype.open&&t.push(XMLHttpRequest.prototype.open)}catch(i){}try{Node&&Node.prototype&&Node.prototype.cloneNode&&t.push(Node.prototype.cloneNode)}catch(o){}if(t.forEach(t=>{try{let n=Function.prototype.toString.call(t);/\[native code\]/.test(n)||e.push({fn:t.name||"anonymous",reason:"toString altered"})}catch(r){e.push({fn:t&&t.name?t.name:"unknown",reason:"toString threw"})}}),"object"==typeof navigator)try{let s=Object.getPrototypeOf(navigator);if(s&&s.constructor){let c=Function.prototype.toString.call(s.constructor);/\[native code\]/.test(c)||e.push({fn:"navigator.prototype",reason:"prototype constructor altered"})}}catch(l){}return e.length?e:null}catch(h){return null}},detectExtensions(){try{let e=[],t=Array.from(document.querySelectorAll("script[src], link[href], iframe[src]"));t.forEach(t=>{let n=t.src||t.href||t.getAttribute("src")||t.getAttribute("href")||"";n&&/(chrome-extension|moz-extension):\/\//i.test(n)&&e.push({type:t.tagName,src:n})});let n=[/(^|\b)(ublock|uBlock|adblock|adguard|ghostery|privacybadger|react-devtools|redux-devtools|web-developer)(\b|$)/i,/(^|\b)(extension-pane|extension-panel|browser-extension)(\b|$)/i],r=Array.from(document.querySelectorAll("[id],[class]")).slice(0,400);for(let a=0;a<r.length&&e.length<12;a++){let i=r[a],o=`${i.id||""} ${i.className||""}`;for(let s of n)if(s.test(o)){e.push({type:"dom-suspect",snippet:(i.outerHTML||i.tagName).slice(0,200)});break}}return"object"==typeof window.chrome&&window.chrome.runtime&&window.chrome.runtime.id&&e.push({type:"chrome-runtime",id:window.chrome.runtime.id}),e.length?e:null}catch(c){return null}},async _sha256Hex(e){try{let t=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",t),r=new Uint8Array(n);return Array.from(r).map(e=>e.toString(16).padStart(2,"0")).join("")}catch(a){return null}},async sendToServer(e,t={}){try{let n=await this.performIntegrityCheck(),r=null;try{let a=document.createElement("canvas");a.width=220,a.height=60;let i=a.getContext("2d");i.textBaseline="top",i.font='16px "Arial"',i.fillStyle="#f60",i.fillRect(10,10,100,20),i.fillStyle="#069",i.fillText("IntegrityChecker-FP",12,12),r=await this._sha256Hex(a.toDataURL())}catch(o){r=null}let s=await this.detectProxyVPN(),c={results:n.results,passed:n.passed,score:n.score,token:n.token,timestamp:n.timestamp,canvasHash:r,stun:s,userAgent:navigator&&navigator.userAgent,timezone:"undefined"!=typeof Intl&&Intl.DateTimeFormat?Intl.DateTimeFormat().resolvedOptions().timeZone:null,extra:t},l=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),credentials:"include"});return await l.json()}catch(h){return{ok:!1,error:h&&h.message?h.message:String(h)}}},async performIntegrityCheck(){try{let e={environment:this.checkEnvironment(),headless:this.checkHeadless(),features:this.checkBrowserFeatures(),userInteraction:this.hasUserInteraction(),canvas:this.getCanvasFingerprint(),timing:await this.checkTimingConsistency(),screen:this.checkScreenProperties()},t=this.detectTampering(),n=this.detectExtensions(),r=await this.detectProxyVPN();e.tamper=t,e.extensions=n,e.stun=r||null;let a={environment:1.5,features:1.5,webgl_hardware:1.2,webgl_software:.6,timing:1.2,canvas:1,userInteraction:1,screen:1},i=0;e.environment&&(i+=a.environment),e.features&&(i+=a.features);let o=void 0!==e.features&&this.checkWebGL&&this.checkWebGL();"hardware"===o||!0===o?i+=a.webgl_hardware:"software"===o&&(i+=a.webgl_software),e.timing&&(i+=a.timing),e.canvas&&(i+=a.canvas),e.userInteraction&&(i+=a.userInteraction),e.screen&&(i+=a.screen);let s=0;t&&t.length&&(s+=3),n&&n.length&&(s+=.8),r&&r.publicIps&&Array.isArray(r.publicIps)&&(0===r.publicIps.length&&(s+=.6),r.publicIps.length>1&&(s+=1));let c=Object.values(a).reduce((e,t)=>e+t,0),l=Math.max(0,i-s),h=Math.round(l/c*100)/10,u=h>=6;return{passed:u,score:h,maxScore:10,results:e,token:u?this.generateChallengeToken():null,timestamp:Date.now()}}catch(p){return{passed:!1,score:0,maxScore:10,results:null,token:null,timestamp:Date.now()}}},initUserInteractionTracking(){try{window.hasUserInteracted=!1,["mousedown","mousemove","keydown","touchstart","click"].forEach(e=>{document.addEventListener(e,()=>{window.hasUserInteracted=!0},{once:!0,passive:!0})})}catch(e){}}};"undefined"!=typeof window&&(window.IntegrityChecker=IntegrityChecker,IntegrityChecker.initUserInteractionTracking()),"undefined"!=typeof module&&(module.exports=IntegrityChecker);
