const socket=io();let autoScrollEnabled=!0,isLoadingMoreMessages=!1,SECRET_KEY="xSAjwEE70Ilu4EN6iM1yTB-9A6ut4OfWDVmlZi82Q_w=",currentUser=null,currentRoomId=null,isJoined=!1,userColors={},roomUsers=[],lastMessageId=null;const USER_COLORS=["#28a745","#dc3545","#ffc107","#6f42c1","#fd7e14","#20c997","#e83e8c","#6c757d","#17a2b8"];function setSecretKey(e){SECRET_KEY=e}function encryptMessage(e){let t=CryptoJS.lib.WordArray.random(16),s=CryptoJS.AES.encrypt(e,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:t});return t.toString()+":"+s.toString()}function decryptMessage(e){let t=e.split(":");if(2!==t.length)return console.error("Invalid ciphertext format"),null;let s=CryptoJS.enc.Hex.parse(t[0]),n=t[1],o=CryptoJS.AES.decrypt(n,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:s}).toString(CryptoJS.enc.Utf8);return o||console.warn("Decryption failed for message:",e),o}function validateInputs(){let e=document.getElementById("username").value.trim(),t=document.getElementById("roomId").value.trim(),s=/^[a-zA-Z0-9]{4,20}$/.test(e);document.getElementById("username").style.backgroundColor=s?"lightgreen":"lightcoral";let n=/^\d{1,5}$/.test(t);return document.getElementById("roomId").style.backgroundColor=n?"lightgreen":"lightcoral",s&&n}function scrollToBottom(){let e=document.getElementById("messages");e.scrollTop=e.scrollHeight}function assignUserColor(e){if(!userColors[e]){let t=Object.keys(userColors).length%USER_COLORS.length;userColors[e]=USER_COLORS[t]}return userColors[e]}function createMessageElement(e,t,s,n,o,r){let l=document.createElement("div");l.className=s?"message user":"message receiver",r&&(l.dataset.messageId=r,lastMessageId=r);let i=document.createElement("div");if(i.className="message-content",roomUsers.length>2){if(s)l.style.backgroundColor="#007bff";else{let a=assignUserColor(e);l.style.backgroundColor=a}let d=document.createElement("span");d.className="message-username",d.style.fontWeight="bold",d.style.fontSize="10px",d.style.opacity="0.9",d.style.marginBottom="3px",d.style.display="block",d.style.fontFamily="Poppins, sans-serif",d.textContent=e,i.appendChild(d)}if(o){let c=document.createElement("img");c.src=o,c.alt="User uploaded image",c.style.maxWidth="200px",c.style.borderRadius="8px",i.appendChild(c)}else{let m=document.createElement("div"),g=decryptMessage(t);m.textContent=g||"[Message could not be decrypted]",g||console.warn("Decryption failed for message:",t),i.appendChild(m)}l.appendChild(i);let u=document.createElement("div");if(u.className="message-container",u.style.display="flex",u.style.flexDirection="column",u.style.alignItems=s?"flex-end":"flex-start",u.style.margin="3px 0",u.appendChild(l),n){let y=document.createElement("span");y.className="message-time",y.style.fontSize="8px",y.style.color="#999",y.style.marginTop="2px",y.style.opacity="0.6",y.style.fontFamily="Poppins, sans-serif";let p=new Date(n),f=new Date,E;E=p.toDateString()===f.toDateString()?p.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):p.toLocaleDateString()+" "+p.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),y.textContent=E,u.appendChild(y)}return u}function updateSeenIndicator(){document.querySelectorAll(".seen-indicator").forEach(e=>e.remove())}function showSeenStatus(e,t){document.querySelectorAll(".seen-indicator").forEach(e=>e.remove());let s=document.querySelector(`[data-message-id="${e}"]`);if(!s)return;let n=t.filter(e=>e!==currentUser),o=s.closest(".message-container")?.querySelector(".message.user");if(n.length>0&&o){let r=s.closest(".message-container");if(!r)return;let l=document.createElement("div");l.className="seen-indicator",l.style.fontSize="8px",l.style.color="#888",l.style.marginTop="2px",l.style.fontStyle="italic",l.style.fontFamily="Poppins, sans-serif",l.style.alignSelf="flex-end",1===n.length?l.textContent=`âœ“ Seen by ${n[0]}`:l.textContent=`âœ“ Seen by ${n.join(", ")}`,r.appendChild(l)}}function markMessagesAsSeen(){isJoined&&currentRoomId&&lastMessageId&&socket.emit("markAllSeen",{roomId:currentRoomId})}document.getElementById("join").addEventListener("click",()=>{if(validateInputs()){let e=document.getElementById("username").value.trim(),t=document.getElementById("roomId").value.trim();currentUser=e,currentRoomId=t,socket.emit("joinRoom",{username:e,roomId:t}),document.getElementById("join").disabled=!0,document.getElementById("join").textContent="Joining..."}else alert("Login failed: Please enter valid username and room ID.")}),socket.on("joinConfirmed",({username:e,roomId:t,users:s})=>{console.log("Successfully joined room:",t),isJoined=!0,roomUsers=s||[],userColors={},document.getElementById("login-form").style.display="none",document.getElementById("chat-container").style.display="flex",setTimeout(markMessagesAsSeen,1e3)}),socket.on("joinError",e=>{console.error("Failed to join room:",e),e.includes("already exists")?alert("Username already taken in this room.\nPlease choose a different username."):alert("Failed to join room: "+e),document.getElementById("join").disabled=!1,document.getElementById("join").textContent="Join"}),socket.on("previousMessages",e=>{console.log("Received previous messages:",e);let t=document.getElementById("messages");t.innerHTML="",e.forEach(({username:e,message:s,timestamp:n,imageUrl:o,messageId:r})=>{let l=createMessageElement(e,s,e===currentUser,n,o,r);t.appendChild(l)}),socket.on("disconnect",e=>{console.log("Disconnected from server:",e),isJoined=!1,("io server disconnect"===e||"ping timeout"===e)&&(document.getElementById("login-form").style.display="block",document.getElementById("chat-container").style.display="none",document.getElementById("join").disabled=!1,document.getElementById("join").textContent="Join")}),scrollToBottom()}),socket.on("olderMessages",e=>{let t=document.getElementById("messages"),s=t.scrollHeight;e.forEach(({username:e,message:s,timestamp:n,imageUrl:o,messageId:r})=>{let l=createMessageElement(e,s,e===currentUser,n,o,r);t.insertBefore(l,t.firstChild)}),t.scrollTop=t.scrollHeight-s,isLoadingMoreMessages=!1}),socket.on("chatMessage",({user:e,message:t,imageUrl:s,messageId:n,timestamp:o})=>{let r;r=s?createMessageElement(e,null,e===currentUser,o,s,n):createMessageElement(e,t,e===currentUser,o,null,n),document.getElementById("messages").appendChild(r),autoScrollEnabled&&scrollToBottom(),e!==currentUser&&setTimeout(markMessagesAsSeen,500)}),socket.on("messageSeen",({messageId:e,seenBy:t})=>{showSeenStatus(e,t)}),document.getElementById("imageUpload").addEventListener("change",function(){let e=document.getElementById("imageUploadLabel"),t=this.files[0];if(t&&isJoined){e.textContent=`ðŸ“· ${t.name}`;let s=new FileReader;s.onload=function(s){let n=s.target.result;socket.emit("imageUpload",{roomId:currentRoomId,file:{name:t.name,data:n}}),document.getElementById("imageUpload").value="",e.textContent="\uD83D\uDCF7"},s.readAsArrayBuffer(t)}else isJoined?e.textContent="\uD83D\uDCF7":(alert("Please join a room first"),this.value="")});let typingTimeout;function sendMessage(){if(!isJoined){console.warn("Cannot send message: not joined to a room");return}let e=document.getElementById("message"),t=e.value.trim();if(t){let s=encryptMessage(t);socket.emit("chatMessage",{roomId:currentRoomId,message:s}),e.value="",socket.emit("stopTyping",currentRoomId)}}document.getElementById("message").addEventListener("input",()=>{isJoined&&currentRoomId&&(socket.emit("typing",currentRoomId),clearTimeout(typingTimeout),typingTimeout=setTimeout(()=>{socket.emit("stopTyping",currentRoomId)},1e3))}),document.getElementById("send").addEventListener("click",sendMessage),document.getElementById("message").addEventListener("keydown",e=>{"Enter"===e.key&&(sendMessage(),e.preventDefault())}),socket.on("typing",e=>{if(!e||e===currentUser)return;let t=document.getElementById("messages");if(!t.querySelector(".typing-indicator")){let s=document.createElement("div");s.className="typing-indicator",s.innerText=`${e} is typing...`,t.appendChild(s),autoScrollEnabled&&scrollToBottom()}}),socket.on("stopTyping",()=>{let e=document.querySelector(".typing-indicator");e&&e.remove()}),socket.on("updateActiveUsers",e=>{roomUsers=e.map(e=>e.username);let t=e.filter(e=>e.username!==currentUser).map(e=>e.username).join(", ");document.getElementById("active-users").innerHTML="Active Users: "+(t||"None")}),document.getElementById("messages").addEventListener("scroll",()=>{let e=document.getElementById("messages");if(0===e.scrollTop&&!isLoadingMoreMessages&&isJoined){isLoadingMoreMessages=!0;let t=e.firstChild?.dataset?.timestamp;t?socket.emit("loadMoreMessages",{roomId:currentRoomId,oldestMessageTimestamp:t}):isLoadingMoreMessages=!1}let s=e.scrollHeight-e.scrollTop<=e.clientHeight+5;autoScrollEnabled=s,s&&markMessagesAsSeen()}),window.addEventListener("focus",()=>{isJoined&&markMessagesAsSeen()}),socket.on("connect",()=>{console.log("Connected to server"),currentUser&&currentRoomId&&!isJoined&&(console.log("Reconnecting to room..."),socket.emit("joinRoom",{username:currentUser,roomId:currentRoomId}))}),scrollToBottom();
